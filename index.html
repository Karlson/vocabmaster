<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>VocabMaster</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<script src="https://cdn.tailwindcss.com"></script>
<style>
*{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0f172a;overscroll-behavior:none}
.ag{animation:ag .4s}.ar{animation:ar .4s}
@keyframes ag{50%{transform:scale(1.05);background:rgba(34,197,94,.2)}}
@keyframes ar{50%{transform:scale(.95);background:rgba(239,68,68,.2)}}
.bounce{animation:bn 1s infinite}@keyframes bn{50%{transform:translateY(-8px)}}
textarea,input,select{background:#1e293b;color:#fff;border:1px solid #334155;border-radius:8px;padding:8px 12px;width:100%;font-size:14px;outline:none}
textarea:focus,input:focus{border-color:#6366f1}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:12px;font-weight:600;z-index:999;animation:fo 2.5s forwards}
@keyframes fo{0%,70%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
<div id="app"></div><div id="tc"></div>
<script>
// === WORDS ===
const W=(w,t,e,h)=>[w,t,e,h];
const BI={1:[
W("cat","–∫–æ—Ç","The cat sleeps.","–∂–∏–≤–æ—Ç–Ω–æ–µ"),W("dog","—Å–æ–±–∞–∫–∞","I have a dog.","–∂–∏–≤–æ—Ç–Ω–æ–µ"),W("house","–¥–æ–º","My house.","–∂–∏–ª—å—ë"),W("water","–≤–æ–¥–∞","Drink water.","H2O"),W("food","–µ–¥–∞","Good food.","–ø–∏—Ç–∞–Ω–∏–µ"),W("book","–∫–Ω–∏–≥–∞","Read a book.","–∑–Ω–∞–Ω–∏—è"),W("sun","—Å–æ–ª–Ω—Ü–µ","Bright sun.","–∑–≤–µ–∑–¥–∞"),W("happy","—Å—á–∞—Å—Ç–ª–∏–≤—ã–π","I am happy.","—Ä–∞–¥–æ—Å—Ç—å"),W("big","–±–æ–ª—å—à–æ–π","Big tree.","–Ω–µ small"),W("small","–º–∞–ª–µ–Ω—å–∫–∏–π","Small bird.","–Ω–µ big"),
W("run","–±–µ–∂–∞—Ç—å","I run daily.","–±—ã—Å—Ç—Ä–æ"),W("eat","–µ—Å—Ç—å","Eat breakfast.","–ø–∏—â–∞"),W("red","–∫—Ä–∞—Å–Ω—ã–π","Red apple.","—Ü–≤–µ—Ç"),W("green","–∑–µ–ª—ë–Ω—ã–π","Green grass.","—Ü–≤–µ—Ç"),W("time","–≤—Ä–µ–º—è","What time?","—á–∞—Å—ã"),W("love","–ª—é–±–æ–≤—å","I love you.","—á—É–≤—Å—Ç–≤–æ"),W("good","—Ö–æ—Ä–æ—à–∏–π","Good morning!","–Ω–µ bad"),W("bad","–ø–ª–æ—Ö–æ–π","Bad weather.","–Ω–µ good"),W("new","–Ω–æ–≤—ã–π","New car.","–Ω–µ old"),W("old","—Å—Ç–∞—Ä—ã–π","Old man.","–Ω–µ new"),
W("boy","–º–∞–ª—å—á–∏–∫","Young boy.","—Ä–µ–±—ë–Ω–æ–∫"),W("girl","–¥–µ–≤–æ—á–∫–∞","Little girl.","—Ä–µ–±—ë–Ω–æ–∫"),W("man","–º—É–∂—á–∏–Ω–∞","Tall man.","–≤–∑—Ä–æ—Å–ª—ã–π"),W("woman","–∂–µ–Ω—â–∏–Ω–∞","Kind woman.","–≤–∑—Ä–æ—Å–ª–∞—è"),W("tree","–¥–µ—Ä–µ–≤–æ","Tall tree.","–ª–µ—Å"),W("fish","—Ä—ã–±–∞","I like fish.","–≤–æ–¥–∞"),W("milk","–º–æ–ª–æ–∫–æ","Cold milk.","–Ω–∞–ø–∏—Ç–æ–∫"),W("bread","—Ö–ª–µ–±","Fresh bread.","–µ–¥–∞"),W("hand","—Ä—É–∫–∞","My hand.","—Ç–µ–ª–æ"),W("head","–≥–æ–ª–æ–≤–∞","Head hurts.","—Ç–µ–ª–æ"),
W("eye","–≥–ª–∞–∑","Blue eyes.","–≤–∏–¥–µ—Ç—å"),W("door","–¥–≤–µ—Ä—å","Open door.","–≤—Ö–æ–¥"),W("car","–º–∞—à–∏–Ω–∞","Fast car.","—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç"),W("work","—Ä–∞–±–æ—Ç–∞","Go to work.","—Ç—Ä—É–¥"),W("sleep","—Å–ø–∞—Ç—å","Want to sleep.","–æ—Ç–¥—ã—Ö"),W("cold","—Ö–æ–ª–æ–¥–Ω—ã–π","Cold water.","–Ω–µ hot"),W("hot","–≥–æ—Ä—è—á–∏–π","Hot tea.","–Ω–µ cold"),W("white","–±–µ–ª—ã–π","White snow.","—Ü–≤–µ—Ç"),W("black","—á—ë—Ä–Ω—ã–π","Black cat.","—Ü–≤–µ—Ç"),W("rain","–¥–æ–∂–¥—å","It is raining.","–ø–æ–≥–æ–¥–∞"),
W("friend","–¥—Ä—É–≥","Best friend.","–±–ª–∏–∑–∫–∏–π"),W("mother","–º–∞—Ç—å","My mother.","–º–∞–º–∞"),W("father","–æ—Ç–µ—Ü","My father.","–ø–∞–ø–∞"),W("sister","—Å–µ—Å—Ç—Ä–∞","Little sister.","—Å–µ–º—å—è"),W("brother","–±—Ä–∞—Ç","Older brother.","—Å–µ–º—å—è"),W("child","—Ä–µ–±—ë–Ω–æ–∫","Happy child.","–º–∞–ª–µ–Ω—å–∫–∏–π"),W("name","–∏–º—è","Your name?","–∑–æ–≤—É—Ç"),W("city","–≥–æ—Ä–æ–¥","Big city.","–º–µ—Å—Ç–æ"),W("room","–∫–æ–º–Ω–∞—Ç–∞","Clean room.","–¥–æ–º"),W("table","—Å—Ç–æ–ª","On the table.","–º–µ–±–µ–ª—å"),
W("chair","—Å—Ç—É–ª","Sit on chair.","–º–µ–±–µ–ª—å"),W("window","–æ–∫–Ω–æ","Open window.","—Å—Ç–µ–∫–ª–æ"),W("money","–¥–µ–Ω—å–≥–∏","Have money.","–ø–ª–∞—Ç–∏—Ç—å"),W("school","—à–∫–æ–ª–∞","Go to school.","—É—á—ë–±–∞"),W("year","–≥–æ–¥","This year.","–≤—Ä–µ–º—è"),W("day","–¥–µ–Ω—å","Nice day.","—Å–≤–µ—Ç–ª–æ"),W("night","–Ω–æ—á—å","Good night.","—Ç–µ–º–Ω–æ"),W("morning","—É—Ç—Ä–æ","Good morning.","–Ω–∞—á–∞–ª–æ –¥–Ω—è"),W("buy","–ø–æ–∫—É–ø–∞—Ç—å","Buy a gift.","—Ç—Ä–∞—Ç–∏—Ç—å"),W("give","–¥–∞–≤–∞—Ç—å","Give me.","–ø–µ—Ä–µ–¥–∞—Ç—å"),
W("take","–±—Ä–∞—Ç—å","Take it.","–≤–∑—è—Ç—å"),W("come","–ø—Ä–∏—Ö–æ–¥–∏—Ç—å","Come here.","—Å—é–¥–∞"),W("go","–∏–¥—Ç–∏","Let us go.","—Ç—É–¥–∞"),W("see","–≤–∏–¥–µ—Ç—å","I see you.","–≥–ª–∞–∑–∞"),W("know","–∑–Ω–∞—Ç—å","I know.","–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"),W("want","—Ö–æ—Ç–µ—Ç—å","I want.","–∂–µ–ª–∞–Ω–∏–µ"),W("think","–¥—É–º–∞—Ç—å","I think so.","–º–æ–∑–≥"),W("say","–≥–æ–≤–æ—Ä–∏—Ç—å","Say hello.","—Å–ª–æ–≤–∞"),W("help","–ø–æ–º–æ—â—å","Help me.","–ø–æ–¥–¥–µ—Ä–∂–∫–∞"),W("open","–æ—Ç–∫—Ä—ã–≤–∞—Ç—å","Open box.","–Ω–µ close"),
W("close","–∑–∞–∫—Ä—ã–≤–∞—Ç—å","Close door.","–Ω–µ open"),W("fast","–±—ã—Å—Ç—Ä—ã–π","Fast runner.","–Ω–µ slow"),W("slow","–º–µ–¥–ª–µ–Ω–Ω—ã–π","Slow turtle.","–Ω–µ fast"),W("clean","—á–∏—Å—Ç—ã–π","Clean water.","–Ω–µ dirty"),W("easy","–ª—ë–≥–∫–∏–π","Easy task.","–Ω–µ hard"),W("young","–º–æ–ª–æ–¥–æ–π","Young man.","–Ω–µ old"),W("long","–¥–ª–∏–Ω–Ω—ã–π","Long road.","–Ω–µ short"),W("short","–∫–æ—Ä–æ—Ç–∫–∏–π","Short story.","–Ω–µ long"),W("write","–ø–∏—Å–∞—Ç—å","Write letter.","—Ä—É—á–∫–∞"),W("read","—á–∏—Ç–∞—Ç—å","Read book.","—Ç–µ–∫—Å—Ç"),
W("play","–∏–≥—Ä–∞—Ç—å","Play game.","—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ"),W("sit","—Å–∏–¥–µ—Ç—å","Sit down.","—Å—Ç—É–ª"),W("stand","—Å—Ç–æ—è—Ç—å","Stand up.","–Ω–æ–≥–∏"),W("walk","—Ö–æ–¥–∏—Ç—å","Walk slowly.","–ø–µ—à–∫–æ–º"),W("listen","—Å–ª—É—à–∞—Ç—å","Listen to me.","—É—à–∏"),W("wait","–∂–¥–∞—Ç—å","Wait for me.","—Ç–µ—Ä–ø–µ–Ω–∏–µ"),W("smile","—É–ª—ã–±–∫–∞","Nice smile.","–ª–∏—Ü–æ"),W("fly","–ª–µ—Ç–∞—Ç—å","Birds fly.","–Ω–µ–±–æ"),W("swim","–ø–ª–∞–≤–∞—Ç—å","I can swim.","–≤–æ–¥–∞"),W("drive","–≤–æ–¥–∏—Ç—å","Drive car.","—Ä—É–ª—å"),
W("cook","–≥–æ—Ç–æ–≤–∏—Ç—å","Cook dinner.","–∫—É—Ö–Ω—è"),W("wash","–º—ã—Ç—å","Wash hands.","–≤–æ–¥–∞"),W("blue","—Å–∏–Ω–∏–π","Blue sky.","—Ü–≤–µ—Ç"),W("flower","—Ü–≤–µ—Ç–æ–∫","Nice flower.","—Ä–∞—Å—Ç–µ–Ω–∏–µ"),W("bird","–ø—Ç–∏—Ü–∞","Small bird.","–ª–µ—Ç–∞–µ—Ç"),W("river","—Ä–µ–∫–∞","Long river.","—Ç–µ—á—ë—Ç"),W("sea","–º–æ—Ä–µ","Blue sea.","–≤–æ–¥–∞"),W("snow","—Å–Ω–µ–≥","White snow.","–∑–∏–º–∞"),W("fire","–æ–≥–æ–Ω—å","Warm fire.","–≥–æ—Ä–∏—Ç"),W("star","–∑–≤–µ–∑–¥–∞","Bright star.","–Ω–æ—á—å"),
W("song","–ø–µ—Å–Ω—è","Nice song.","–º–µ–ª–æ–¥–∏—è"),W("heart","—Å–µ—Ä–¥—Ü–µ","Kind heart.","–æ—Ä–≥–∞–Ω"),W("face","–ª–∏—Ü–æ","Happy face.","–≥–æ–ª–æ–≤–∞"),W("ear","—É—Ö–æ","My ears.","—Å–ª—ã—à–∞—Ç—å"),W("leg","–Ω–æ–≥–∞","Strong leg.","—Ç–µ–ª–æ"),W("cup","—á–∞—à–∫–∞","Cup of tea.","–ø–æ—Å—É–¥–∞"),W("key","–∫–ª—é—á","My key.","–¥–≤–µ—Ä—å"),W("bed","–∫—Ä–æ–≤–∞—Ç—å","Go to bed.","—Å–ø–∞—Ç—å"),W("egg","—è–π—Ü–æ","Boiled egg.","–µ–¥–∞"),W("apple","—è–±–ª–æ–∫–æ","Red apple.","—Ñ—Ä—É–∫—Ç"),W("tea","—á–∞–π","Hot tea.","–Ω–∞–ø–∏—Ç–æ–∫"),W("coffee","–∫–æ—Ñ–µ","Black coffee.","–Ω–∞–ø–∏—Ç–æ–∫"),
],2:[
W("weather","–ø–æ–≥–æ–¥–∞","Nice weather.","–¥–æ–∂–¥—å/—Å–æ–ª–Ω—Ü–µ"),W("kitchen","–∫—É—Ö–Ω—è","In kitchen.","–∫–æ–º–Ω–∞—Ç–∞"),W("believe","–≤–µ—Ä–∏—Ç—å","I believe.","–¥–æ–≤–µ—Ä—è—Ç—å"),W("usually","–æ–±—ã—á–Ω–æ","Usually at 7.","–∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ"),W("already","—É–∂–µ","Already eaten.","–∫ –º–æ–º–µ–Ω—Ç—É"),W("between","–º–µ–∂–¥—É","Sit between.","–ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ"),W("different","—Ä–∞–∑–ª–∏—á–Ω—ã–π","They differ.","–Ω–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π"),W("important","–≤–∞–∂–Ω—ã–π","Very important.","–∑–Ω–∞—á–µ–Ω–∏–µ"),W("together","–≤–º–µ—Å—Ç–µ","Go together.","–Ω–µ –æ—Ç–¥–µ–ª—å–Ω–æ"),W("mountain","–≥–æ—Ä–∞","Tall mountain.","–≤—ã—Å–æ—Ç–∞"),
W("beautiful","–∫—Ä–∞—Å–∏–≤—ã–π","Beautiful sunset.","–ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π"),W("remember","–ø–æ–º–Ω–∏—Ç—å","I remember.","–Ω–µ –∑–∞–±—ã—Ç—å"),W("perhaps","–≤–æ–∑–º–æ–∂–Ω–æ","Perhaps rain.","–º–æ–∂–µ—Ç –±—ã—Ç—å"),W("journey","–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ","Long journey.","–ø–æ–µ–∑–¥–∫–∞"),W("difficult","—Ç—Ä—É–¥–Ω—ã–π","Difficult task.","–Ω–µ –ª—ë–≥–∫–∏–π"),W("explain","–æ–±—ä—è—Å–Ω—è—Ç—å","Please explain.","–ø–æ–Ω—è—Ç–Ω–æ"),W("receive","–ø–æ–ª—É—á–∞—Ç—å","Received letter.","–Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å"),W("several","–Ω–µ—Å–∫–æ–ª—å–∫–æ","Several people.","–±–æ–ª—å—à–µ –¥–≤—É—Ö"),W("prepare","–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è","Prepare exam.","–∑–∞—Ä–∞–Ω–µ–µ"),W("enough","–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ","Enough.","—Ö–≤–∞—Ç–∏—Ç"),
W("achieve","–¥–æ—Å—Ç–∏–≥–∞—Ç—å","Achieve goals.","–¥–æ–±–∏—Ç—å—Å—è"),W("trouble","–ø—Ä–æ–±–ª–µ–º–∞","In trouble.","–Ω–µ–ø—Ä–∏—è—Ç–Ω–æ—Å—Ç—å"),W("suddenly","–≤–Ω–µ–∑–∞–ø–Ω–æ","Suddenly rained.","–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ"),W("although","—Ö–æ—Ç—è","Although rained.","–Ω–µ—Å–º–æ—Ç—Ä—è"),W("honest","—á–µ—Å—Ç–Ω—ã–π","Be honest.","–Ω–µ –ª–∂–∏–≤—ã–π"),W("provide","–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å","Provide ID.","–æ–±–µ—Å–ø–µ—á–∏—Ç—å"),W("strength","—Å–∏–ª–∞","Inner strength.","–º–æ—â—å"),W("imagine","–ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å","Imagine world.","—Ñ–∞–Ω—Ç–∞–∑–∏—è"),W("contain","—Å–æ–¥–µ—Ä–∂–∞—Ç—å","Contains books.","–≤–∫–ª—é—á–∞—Ç—å"),W("favorite","–ª—é–±–∏–º—ã–π","Favorite movie.","–Ω—Ä–∞–≤–∏—Ç—Å—è"),
W("promise","–æ–±–µ—â–∞–Ω–∏–µ","I promise.","—Å–ª–æ–≤–æ"),W("beyond","–∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏","Beyond horizon.","–¥–∞–ª—å—à–µ"),W("curious","–ª—é–±–æ–ø—ã—Ç–Ω—ã–π","Curious child.","—É–∑–Ω–∞—Ç—å"),W("escape","–ø–æ–±–µ–≥","Escape prison.","—Å–±–µ–∂–∞—Ç—å"),W("increase","—É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å","Increase volume.","–±–æ–ª—å—à–µ"),W("accept","–ø—Ä–∏–Ω–∏–º–∞—Ç—å","Accept offer.","—Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è"),W("advice","—Å–æ–≤–µ—Ç","Good advice.","—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"),W("allow","–ø–æ–∑–≤–æ–ª—è—Ç—å","Allow me.","—Ä–∞–∑—Ä–µ—à–∏—Ç—å"),W("ancient","–¥—Ä–µ–≤–Ω–∏–π","Ancient city.","—Å—Ç–∞—Ä—ã–π"),W("bright","—è—Ä–∫–∏–π","Bright star.","—Å–∏—è—é—â–∏–π"),
W("calm","—Å–ø–æ–∫–æ–π–Ω—ã–π","Stay calm.","–Ω–µ –≤–æ–ª–Ω–µ–Ω–∏–µ"),W("cause","–ø—Ä–∏—á–∏–Ω–∞","The cause.","–∏—Å—Ç–æ—á–Ω–∏–∫"),W("compare","—Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å","Compare two.","–æ—Ç–ª–∏—á–∏—è"),W("consider","—Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å","Consider option.","–æ–±–¥—É–º–∞—Ç—å"),W("create","—Å–æ–∑–¥–∞–≤–∞—Ç—å","Create new.","—Å –Ω—É–ª—è"),W("develop","—Ä–∞–∑–≤–∏–≤–∞—Ç—å","Develop skill.","—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å"),W("discover","–æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å","Discover secret.","–Ω–∞–π—Ç–∏"),W("effort","—É—Å–∏–ª–∏–µ","Make effort.","—Å—Ç–∞—Ä–∞—Ç—å—Å—è"),W("especially","–æ—Å–æ–±–µ–Ω–Ω–æ","Especially you.","–ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ"),W("excellent","–æ—Ç–ª–∏—á–Ω—ã–π","Excellent work!","–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω—ã–π"),
W("foreign","–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π","Foreign country.","–∑–∞—Ä—É–±–µ–∂–Ω—ã–π"),W("improve","—É–ª—É—á—à–∞—Ç—å","Improve skills.","–ª—É—á—à–µ"),W("instead","–≤–º–µ—Å—Ç–æ","Use instead.","–∑–∞–º–µ–Ω–∞"),W("notice","–∑–∞–º–µ—á–∞—Ç—å","I noticed.","–≤–Ω–∏–º–∞–Ω–∏–µ"),W("opinion","–º–Ω–µ–Ω–∏–µ","My opinion.","–≤–∑–≥–ª—è–¥"),W("patient","—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π","Be patient.","–∂–¥–∞—Ç—å"),W("protect","–∑–∞—â–∏—â–∞—Ç—å","Protect nature.","–æ—Ö—Ä–∞–Ω—è—Ç—å"),W("remain","–æ—Å—Ç–∞–≤–∞—Ç—å—Å—è","Remain seated.","–Ω–µ —É—Ö–æ–¥–∏—Ç—å"),W("require","—Ç—Ä–µ–±–æ–≤–∞—Ç—å","Requires time.","–Ω—É–∂–¥–∞—Ç—å—Å—è"),W("similar","–ø–æ—Ö–æ–∂–∏–π","Look similar.","–Ω–∞–ø–æ–º–∏–Ω–∞—é—â–∏–π"),
W("suggest","–ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å","I suggest.","—Å–æ–≤–µ—Ç"),W("survive","–≤—ã–∂–∏–≤–∞—Ç—å","Survive storm.","–∂–∏–≤—ã–º"),W("prevent","–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å","Prevent mistake.","–Ω–µ –¥–æ–ø—É—Å—Ç–∏—Ç—å"),W("rare","—Ä–µ–¥–∫–∏–π","Rare flower.","–Ω–µ —á–∞—Å—Ç—ã–π"),W("realize","–æ—Å–æ–∑–Ω–∞–≤–∞—Ç—å","I realized.","–ø–æ–Ω—è—Ç—å"),W("reduce","—É–º–µ–Ω—å—à–∞—Ç—å","Reduce costs.","–Ω–µ —É–≤–µ–ª–∏—á–∏—Ç—å"),W("replace","–∑–∞–º–µ–Ω—è—Ç—å","Replace battery.","–Ω–æ–≤–æ–µ"),W("respect","—É–≤–∞–∂–µ–Ω–∏–µ","Show respect.","–ø–æ—á—Ç–µ–Ω–∏–µ"),W("respond","–æ—Ç–≤–µ—á–∞—Ç—å","Respond quickly.","—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å"),W("result","—Ä–µ–∑—É–ª—å—Ç–∞—Ç","Good result.","–∏—Ç–æ–≥"),
W("share","–¥–µ–ª–∏—Ç—å—Å—è","Share others.","—Å–æ–≤–º–µ—Å—Ç–Ω–æ"),W("skill","–Ω–∞–≤—ã–∫","Useful skill.","—É–º–µ–Ω–∏–µ"),W("support","–ø–æ–¥–¥–µ—Ä–∂–∫–∞","I support.","–ø–æ–º–æ—â—å"),W("variety","—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ","Variety options.","–º–Ω–æ–∂–µ—Å—Ç–≤–æ"),W("victory","–ø–æ–±–µ–¥–∞","Great victory.","–≤—ã–∏–≥—Ä—ã—à"),W("worth","—Å—Ç–æ—è—â–∏–π","It is worth.","—Ü–µ–Ω–Ω—ã–π"),W("avoid","–∏–∑–±–µ–≥–∞—Ç—å","Avoid danger.","–æ–±—Ö–æ–¥–∏—Ç—å"),W("celebrate","–ø—Ä–∞–∑–¥–Ω–æ–≤–∞—Ç—å","Celebrate birthday.","–æ—Ç–º–µ—á–∞—Ç—å"),W("courage","—Å–º–µ–ª–æ—Å—Ç—å","Show courage.","—Ö—Ä–∞–±—Ä–æ—Å—Ç—å"),W("demand","—Ç—Ä–µ–±–æ–≤–∞—Ç—å","High demand.","—Å–ø—Ä–æ—Å"),
W("doubt","—Å–æ–º–Ω–µ–Ω–∏–µ","Without doubt.","–Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å"),W("eager","–Ω–µ—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π","Eager to learn.","—Ä–≤–µ–Ω–∏–µ"),W("emotion","—ç–º–æ—Ü–∏—è","Strong emotion.","—á—É–≤—Å—Ç–≤–æ"),W("event","—Å–æ–±—ã—Ç–∏–µ","Important event.","–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ"),W("generous","—â–µ–¥—Ä—ã–π","Generous gift.","–Ω–µ –∂–∞–¥–Ω—ã–π"),W("huge","–æ–≥—Ä–æ–º–Ω—ã–π","Huge building.","–≥—Ä–æ–º–∞–¥–Ω—ã–π"),W("justice","—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å","Fight justice.","–ø—Ä–∞–≤–æ—Å—É–¥–∏–µ"),W("lead","–≤–µ—Å—Ç–∏","Lead team.","—Ä—É–∫–æ–≤–æ–¥–∏—Ç—å"),W("obvious","–æ—á–µ–≤–∏–¥–Ω—ã–π","It is obvious.","—è—Å–Ω—ã–π"),W("risk","—Ä–∏—Å–∫","Take a risk.","–æ–ø–∞—Å–Ω–æ—Å—Ç—å"),
W("succeed","–ø—Ä–µ—É—Å–ø–µ—Ç—å","Succeed in life.","—É–¥–∞—Ç—å—Å—è"),W("talent","—Ç–∞–ª–∞–Ω—Ç","Natural talent.","–¥–∞—Ä"),W("reveal","—Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å","Reveal secret.","–ø–æ–∫–∞–∑–∞—Ç—å"),W("publish","–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å","Publish article.","–∏–∑–¥–∞—Ç—å"),W("recover","–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è","Recover illness.","–≤—ã–∑–¥–æ—Ä–æ–≤–µ—Ç—å"),
],3:[
W("accomplish","–¥–æ—Å—Ç–∏–≥–∞—Ç—å","Accomplished goal.","–≤—ã–ø–æ–ª–Ω–∏—Ç—å"),W("consequence","–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ","Has consequences.","—Ä–µ–∑—É–ª—å—Ç–∞—Ç"),W("enthusiasm","—ç–Ω—Ç—É–∑–∏–∞–∑–º","Great enthusiasm.","–≤–æ–æ–¥—É—à–µ–≤–ª–µ–Ω–∏–µ"),W("approximately","–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ","Approximately 50.","–ø—Ä–∏–º–µ—Ä–Ω–æ"),W("inevitable","–Ω–µ–∏–∑–±–µ–∂–Ω—ã–π","Change inevitable.","–Ω–µ–ª—å–∑—è –∏–∑–±–µ–∂–∞—Ç—å"),W("significant","–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π","Significant change.","—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π"),W("contribute","–≤–Ω–æ—Å–∏—Ç—å –≤–∫–ª–∞–¥","Contribute more.","—É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"),W("establish","—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å","Establish rule.","–æ—Å–Ω–æ–≤–∞—Ç—å"),W("opportunity","–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å","Great opportunity.","—à–∞–Ω—Å"),W("influence","–≤–ª–∏—è–Ω–∏–µ","Positive influence.","–≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ"),
W("challenge","–≤—ã–∑–æ–≤","Accept challenge.","–∏—Å–ø—ã—Ç–∞–Ω–∏–µ"),W("determine","–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å","Determine cause.","–≤—ã—è—Å–Ω–∏—Ç—å"),W("negotiate","–ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã","Negotiate deal.","–¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å—Å—è"),W("consistent","–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π","Be consistent.","—Å—Ç–∞–±–∏–ª—å–Ω—ã–π"),W("emphasize","–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞—Ç—å","Emphasize point.","–≤—ã–¥–µ–ª—è—Ç—å"),W("generate","–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å","Generate ideas.","—Å–æ–∑–¥–∞–≤–∞—Ç—å"),W("implement","–≤–Ω–µ–¥—Ä—è—Ç—å","Implement plan.","—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å"),W("maintain","–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å","Maintain health.","—Å–æ—Ö—Ä–∞–Ω—è—Ç—å"),W("persuade","—É–±–µ–∂–¥–∞—Ç—å","Persuade him.","—Å–∫–ª–æ–Ω–∏—Ç—å"),W("recognize","—É–∑–Ω–∞–≤–∞—Ç—å","Recognize face.","–æ–ø–æ–∑–Ω–∞—Ç—å"),
W("anticipate","–æ–∂–∏–¥–∞—Ç—å","Anticipate success.","–ø—Ä–µ–¥–≤–∏–¥–µ—Ç—å"),W("beneficial","–ø–æ–ª–µ–∑–Ω—ã–π","Beneficial habit.","–ø–æ–ª—å–∑—É"),W("commitment","–ø—Ä–∏–≤–µ—Ä–∂–µ–Ω–Ω–æ—Å—Ç—å","Strong commitment.","–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ"),W("eliminate","—É—Å—Ç—Ä–∞–Ω—è—Ç—å","Eliminate risk.","—É–±—Ä–∞—Ç—å"),W("guarantee","–≥–∞—Ä–∞–Ω—Ç–∏—è","Guarantee quality.","—Ä—É—á–∞—Ç—å—Å—è"),W("sufficient","–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π","Sufficient proof.","—Ö–≤–∞—Ç–∞–µ—Ç"),W("versatile","—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π","Versatile tool.","–º–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü."),W("compromise","–∫–æ–º–ø—Ä–æ–º–∏—Å—Å","Reach compromise.","—É—Å—Ç—É–ø–∫–∞"),W("convince","—É–±–µ–¥–∏—Ç—å","Convince me.","–ø–æ–≤–µ—Ä–∏—Ç—å"),W("deadline","–∫—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫","Meet deadline.","–¥–∞—Ç–∞ —Å–¥–∞—á–∏"),
W("decline","—Å–Ω–∏–∂–∞—Ç—å—Å—è","Sales declined.","—É–º–µ–Ω—å—à–∞—Ç—å—Å—è"),W("efficiency","—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å","Improve efficiency.","–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"),W("evaluate","–æ—Ü–µ–Ω–∏–≤–∞—Ç—å","Evaluate results.","—Ü–µ–Ω–Ω–æ—Å—Ç—å"),W("expansion","—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ","Business expansion.","—É–≤–µ–ª–∏—á–µ–Ω–∏–µ"),W("highlight","–≤—ã–¥–µ–ª—è—Ç—å","Highlight points.","–ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å"),W("integrity","—á–µ—Å—Ç–Ω–æ—Å—Ç—å","Person of integrity.","–ø–æ—Ä—è–¥–æ—á–Ω–æ—Å—Ç—å"),W("justify","–æ–ø—Ä–∞–≤–¥—ã–≤–∞—Ç—å","Justify decision.","–æ–±–æ—Å–Ω–æ–≤–∞—Ç—å"),W("legislation","–∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ","New legislation.","–∑–∞–∫–æ–Ω"),W("nevertheless","—Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ","Nevertheless tried.","–æ–¥–Ω–∞–∫–æ"),W("outcome","—Ä–µ–∑—É–ª—å—Ç–∞—Ç","Positive outcome.","–∏—Ç–æ–≥"),
W("phenomenon","—è–≤–ª–µ–Ω–∏–µ","Natural phenomenon.","—Ñ–µ–Ω–æ–º–µ–Ω"),W("priority","–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç","Top priority.","–ø–µ—Ä–≤–æ–æ—á–µ—Ä–µ–¥–Ω–æ–π"),W("relevant","—É–º–µ—Å—Ç–Ω—ã–π","Relevant info.","–ø–æ–¥—Ö–æ–¥—è—â–∏–π"),W("revenue","–¥–æ—Ö–æ–¥","Annual revenue.","–≤—ã—Ä—É—á–∫–∞"),W("scenario","—Å—Ü–µ–Ω–∞—Ä–∏–π","Worst scenario.","–≤–∞—Ä–∏–∞–Ω—Ç"),W("strategy","—Å—Ç—Ä–∞—Ç–µ–≥–∏—è","Marketing strategy.","–ø–ª–∞–Ω"),W("temporary","–≤—Ä–µ–º–µ–Ω–Ω—ã–π","Temporary fix.","–Ω–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π"),W("transform","–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å","Transform business.","–∏–∑–º–µ–Ω–∏—Ç—å"),W("unique","—É–Ω–∏–∫–∞–ª—å–Ω—ã–π","Unique style.","–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π"),W("widespread","–ø–æ–≤—Å–µ–º–µ—Å—Ç–Ω—ã–π","Widespread use.","—Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π"),
W("accumulate","–Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å","Accumulate data.","—Å–æ–±–∏—Ä–∞—Ç—å"),W("convey","–ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å","Convey message.","–¥–æ–Ω–µ—Å—Ç–∏"),W("perceive","–≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å","Perceive danger.","–æ—â—É—â–∞—Ç—å"),W("reinforce","—É–∫—Ä–µ–ø–ª—è—Ç—å","Reinforce idea.","—É—Å–∏–ª–∏—Ç—å"),W("subsequent","–ø–æ—Å–ª–µ–¥—É—é—â–∏–π","Subsequent events.","—Å–ª–µ–¥—É—é—â–∏–π"),W("yield","–ø—Ä–∏–Ω–æ—Å–∏—Ç—å","Yield results.","–¥–∞–≤–∞—Ç—å"),
],4:[
W("ambiguous","–Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π","Ambiguous statement.","–¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π"),W("contemplate","—Ä–∞–∑–º—ã—à–ª—è—Ç—å","Contemplate meaning.","–¥—É–º–∞—Ç—å"),W("deteriorate","—É—Ö—É–¥—à–∞—Ç—å—Å—è","Health deteriorated.","—Ö—É–∂–µ"),W("exaggerate","–ø—Ä–µ—É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å","Do not exaggerate.","–±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å"),W("fluctuate","–∫–æ–ª–µ–±–∞—Ç—å—Å—è","Prices fluctuate.","—Ç—É–¥–∞-—Å—é–¥–∞"),W("scrutinize","–∏–∑—É—á–∞—Ç—å","Scrutinize evidence.","–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å"),W("unprecedented","–±–µ—Å–ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–Ω—ã–π","Unprecedented event.","–Ω–µ—Ç –∞–Ω–∞–ª–æ–≥–æ–≤"),W("comprehensive","–≤—Å–µ–æ–±—ä–µ–º–ª—é—â–∏–π","Comprehensive guide.","–∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π"),W("sophisticated","–∏–∑–æ—â—Ä—ë–Ω–Ω—ã–π","Sophisticated approach.","—É—Ç–æ–Ω—á—ë–Ω–Ω—ã–π"),W("feasible","–æ—Å—É—â–µ—Å—Ç–≤–∏–º—ã–π","Feasible plan.","—Ä–µ–∞–ª—å–Ω–æ"),
W("jeopardize","—É–≥—Ä–æ–∂–∞—Ç—å","Jeopardize career.","–æ–ø–∞—Å–Ω–æ—Å—Ç—å"),W("legitimate","–∑–∞–∫–æ–Ω–Ω—ã–π","Legitimate concern.","–ø—Ä–∞–≤–æ–º–µ—Ä–Ω—ã–π"),W("meticulous","—Å–∫—Ä—É–ø—É–ª—ë–∑–Ω—ã–π","Meticulous work.","—Ç—â–∞—Ç–µ–ª—å–Ω—ã–π"),W("obsolete","—É—Å—Ç–∞—Ä–µ–≤—à–∏–π","Obsolete tech.","–Ω–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π"),W("prevalent","—Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π","Prevalent disease.","–ø—Ä–µ–æ–±–ª–∞–¥–∞—é—â–∏–π"),W("undermine","–ø–æ–¥—Ä—ã–≤–∞—Ç—å","Undermine authority.","–æ—Å–ª–∞–±–ª—è—Ç—å"),W("viable","–∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω—ã–π","Viable solution.","—Ä–∞–±–æ—á–∏–π"),W("alleviate","–æ–±–ª–µ–≥—á–∞—Ç—å","Alleviate pain.","—É–º–µ–Ω—å—à–∏—Ç—å"),W("empirical","—ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–π","Empirical evidence.","–Ω–∞ –æ–ø—ã—Ç–µ"),W("hierarchy","–∏–µ—Ä–∞—Ä—Ö–∏—è","Corporate hierarchy.","—É—Ä–æ–≤–Ω–∏"),
W("inherent","–Ω–µ–æ—Ç—ä–µ–º–ª–µ–º—ã–π","Inherent risk.","–ø—Ä–∏—Å—É—â–∏–π"),W("paradigm","–ø–∞—Ä–∞–¥–∏–≥–º–∞","Paradigm shift.","–º–æ–¥–µ–ª—å"),W("reconcile","–ø—Ä–∏–º–∏—Ä—è—Ç—å","Reconcile differences.","—Å–æ–≥–ª–∞—Å–∏–µ"),W("coherent","—Å–≤—è–∑–Ω—ã–π","Coherent argument.","–ª–æ–≥–∏—á–Ω—ã–π"),W("exacerbate","—É—Å—É–≥—É–±–ª—è—Ç—å","Exacerbate problem.","—Ö—É–∂–µ"),W("formidable","–≥—Ä–æ–∑–Ω—ã–π","Formidable foe.","–≤–Ω—É—à–∏—Ç–µ–ª—å–Ω—ã–π"),W("hinder","–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–æ–≤–∞—Ç—å","Hinder progress.","–º–µ—à–∞—Ç—å"),W("imminent","–Ω–µ–º–∏–Ω—É–µ–º—ã–π","Imminent threat.","–≤–æ—Ç-–≤–æ—Ç"),W("mitigate","—Å–º—è–≥—á–∞—Ç—å","Mitigate risk.","—É–º–µ–Ω—å—à–∏—Ç—å"),W("nuance","–Ω—é–∞–Ω—Å","Subtle nuance.","—Ç–æ–Ω–∫–æ—Å—Ç—å"),
W("paramount","–ø–µ—Ä–≤–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π","Paramount importance.","–≥–ª–∞–≤–Ω–µ–π—à–∏–π"),W("plausible","–ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–π","Plausible theory.","–≤–µ—Ä–æ—è—Ç–Ω—ã–π"),W("profound","–≥–ª—É–±–æ–∫–∏–π","Profound impact.","–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π"),W("resilient","—Å—Ç–æ–π–∫–∏–π","Resilient person.","–≤—ã–Ω–æ—Å–ª–∏–≤—ã–π"),W("sustain","–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å","Sustain growth.","—Å–æ—Ö—Ä–∞–Ω—è—Ç—å"),W("tangible","–æ—Å—è–∑–∞–µ–º—ã–π","Tangible results.","—Ä–µ–∞–ª—å–Ω—ã–π"),W("volatile","–∏–∑–º–µ–Ω—á–∏–≤—ã–π","Volatile market.","–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π"),W("bolster","—É–∫—Ä–µ–ø–ª—è—Ç—å","Bolster confidence.","–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å"),W("pragmatic","–ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π","Pragmatic approach.","–ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π"),W("corroborate","–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å","Corroborate story.","–ø–æ–¥–∫—Ä–µ–ø–∏—Ç—å"),
W("eradicate","–∏—Å–∫–æ—Ä–µ–Ω—è—Ç—å","Eradicate disease.","—É–Ω–∏—á—Ç–æ–∂–∏—Ç—å"),W("impeccable","–±–µ–∑—É–ø—Ä–µ—á–Ω—ã–π","Impeccable taste.","–∏–¥–µ–∞–ª—å–Ω—ã–π"),W("lucrative","–ø—Ä–∏–±—ã–ª—å–Ω—ã–π","Lucrative deal.","–≤—ã–≥–æ–¥–Ω—ã–π"),W("pervasive","–≤—Å–µ–ø—Ä–æ–Ω–∏–∫–∞—é—â–∏–π","Pervasive influence.","–ø–æ–≤—Å–µ–º–µ—Å—Ç–Ω—ã–π"),W("superfluous","–ª–∏—à–Ω–∏–π","Superfluous details.","–∏–∑–±—ã—Ç–æ—á–Ω—ã–π"),W("diligent","—É—Å–µ—Ä–¥–Ω—ã–π","Diligent student.","–ø—Ä–∏–ª–µ–∂–Ω—ã–π"),W("trajectory","—Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è","Career trajectory.","–ø—É—Ç—å"),W("disparity","–Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ","Income disparity.","—Ä–∞–∑—Ä—ã–≤"),W("expedite","—É—Å–∫–æ—Ä—è—Ç—å","Expedite process.","–±—ã—Å—Ç—Ä–µ–µ"),W("fallacy","–∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ","Logical fallacy.","–æ—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏"),
],5:[
W("acquiesce","—É—Å—Ç—É–ø–∏—Ç—å","Acquiesced demands.","–Ω–µ—Ö–æ—Ç—è"),W("circumvent","–æ–±—Ö–æ–¥–∏—Ç—å","Circumvent rules.","–æ–±—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å"),W("ephemeral","–º–∏–º–æ–ª—ë—Ç–Ω—ã–π","Ephemeral beauty.","–∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π"),W("quintessential","—Ç–∏–ø–∏—á–Ω–µ–π—à–∏–π","Quintessential example.","—Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π"),W("vindicate","–æ–ø—Ä–∞–≤–¥–∞—Ç—å","Evidence vindicated.","–¥–æ–∫–∞–∑–∞—Ç—å"),W("perfunctory","—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π","Perfunctory check.","–¥–ª—è –≥–∞–ª–æ—á–∫–∏"),W("recalcitrant","–Ω–µ–ø–æ–∫–æ—Ä–Ω—ã–π","Recalcitrant student.","—É–ø—Ä—è–º—ã–π"),W("serendipity","—Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å","By serendipity.","—É–¥–∞—á–∞"),W("magnanimous","–≤–µ–ª–∏–∫–æ–¥—É—à–Ω—ã–π","Magnanimous gesture.","–±–ª–∞–≥–æ—Ä–æ–¥–Ω—ã–π"),W("obfuscate","–∑–∞–ø—É—Ç—ã–≤–∞—Ç—å","Obfuscate truth.","–Ω–µ –ø–æ–Ω—è—Ç–Ω—ã–π"),
W("pernicious","–ø–∞–≥—É–±–Ω—ã–π","Pernicious influence.","–≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π"),W("tenacious","—É–ø–æ—Ä–Ω—ã–π","Tenacious fighter.","–Ω–∞—Å—Ç–æ–π—á–∏–≤—ã–π"),W("capricious","–∫–∞–ø—Ä–∏–∑–Ω—ã–π","Capricious weather.","–ø–µ—Ä–µ–º–µ–Ω—á–∏–≤—ã–π"),W("gregarious","–æ–±—â–∏—Ç–µ–ª—å–Ω—ã–π","Gregarious person.","–∫–æ–º–ø–∞–Ω–∏—è"),W("loquacious","—Å–ª–æ–≤–æ–æ—Ö–æ—Ç–ª–∏–≤—ã–π","Loquacious neighbor.","–±–æ–ª—Ç–ª–∏–≤—ã–π"),W("nefarious","–≥–Ω—É—Å–Ω—ã–π","Nefarious scheme.","–∑–ª–æ–¥–µ–π—Å–∫–∏–π"),W("ostentatious","–ø–æ–∫–∞–∑–Ω–æ–π","Ostentatious wealth.","–Ω–∞–ø–æ–∫–∞–∑"),W("sagacious","–ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π","Sagacious leader.","–º—É–¥—Ä—ã–π"),W("conundrum","–≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞","Moral conundrum.","–¥–∏–ª–µ–º–º–∞"),W("inexorable","–Ω–µ—É–º–æ–ª–∏–º—ã–π","Inexorable time.","–Ω–µ–æ—Å—Ç–∞–Ω–æ–≤–∏–º—ã–π"),
W("inscrutable","–Ω–µ–ø–æ—Å—Ç–∏–∂–∏–º—ã–π","Inscrutable face.","–∑–∞–≥–∞–¥–æ—á–Ω—ã–π"),W("sycophant","–ø–æ–¥—Ö–∞–ª–∏–º","Many sycophants.","–ª—å—Å—Ç–µ—Ü"),W("intransigent","–Ω–µ–ø—Ä–µ–∫–ª–æ–Ω–Ω—ã–π","Intransigent stance.","–±–µ—Å–∫–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω—ã–π"),W("bellicose","–≤–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π","Bellicose leader.","–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π"),W("cacophony","–∫–∞–∫–æ—Ñ–æ–Ω–∏—è","Cacophony sounds.","–¥–∏—Å–≥–∞—Ä–º–æ–Ω–∏—è"),W("ebullient","–∫–∏–ø—É—á–∏–π","Ebullient personality.","—Ä–∞–¥–æ—Å—Ç–Ω—ã–π"),W("laconic","–ª–∞–∫–æ–Ω–∏—á–Ω—ã–π","Laconic reply.","–∫—Ä–∞—Ç–∫–∏–π"),W("quixotic","–¥–æ–Ω–∫–∏—Ö–æ—Ç—Å–∫–∏–π","Quixotic quest.","–Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π"),W("soporific","—Å–Ω–æ—Ç–≤–æ—Ä–Ω—ã–π","Soporific lecture.","—É—Å—ã–ø–ª—è—é—â–∏–π"),W("whimsical","–ø—Ä–∏—á—É–¥–ª–∏–≤—ã–π","Whimsical idea.","—Ñ–∞–Ω—Ç–∞–∑–∏–π–Ω—ã–π"),
W("zealot","—Ñ–∞–Ω–∞—Ç–∏–∫","Political zealot.","–ø—Ä–∏–≤–µ—Ä–∂–µ–Ω–µ—Ü"),W("capitulate","–∫–∞–ø–∏—Ç—É–ª–∏—Ä–æ–≤–∞—Ç—å","Forced capitulate.","—Å–¥–∞—Ç—å—Å—è"),W("duplicity","–¥–≤—É–ª–∏—á–∏–µ","Full of duplicity.","–ª–∏—Ü–µ–º–µ—Ä–∏–µ"),W("esoteric","—ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–π","Esoteric knowledge.","–¥–ª—è –Ω–µ–º–Ω–æ–≥–∏—Ö"),W("hegemony","–≥–µ–≥–µ–º–æ–Ω–∏—è","Cultural hegemony.","–≥–æ—Å–ø–æ–¥—Å—Ç–≤–æ"),W("opulent","—Ä–æ—Å–∫–æ—à–Ω—ã–π","Opulent mansion.","–±–æ–≥–∞—Ç—ã–π"),W("perfidious","–≤–µ—Ä–æ–ª–æ–º–Ω—ã–π","Perfidious ally.","–ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å–∫–∏–π"),W("sanguine","–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π","Sanguine outlook.","–∂–∏–∑–Ω–µ—Ä–∞–¥–æ—Å—Ç–Ω—ã–π"),W("mellifluous","–º–µ–ª–æ–¥–∏—á–Ω—ã–π","Mellifluous voice.","—Å–ª–∞–¥–∫–æ–∑–≤—É—á–Ω—ã–π"),W("hubris","–≥–æ—Ä–¥—ã–Ω—è","His hubris.","—Å–∞–º–æ–Ω–∞–¥–µ—è–Ω–Ω–æ—Å—Ç—å"),
]};

// === STORAGE ===
const LS={p:'vm2_progress',u:'vm2_user_words',s:'vm2_sound',k:'vm2_streak'};
function load(k,d){try{return JSON.parse(localStorage.getItem(k))||d}catch(e){return d}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function loadUW(){return load(LS.u,{1:[],2:[],3:[],4:[],5:[]})}
function getDB(){const uw=loadUW();const db={};for(let l=1;l<=5;l++)db[l]=[...(BI[l]||[]),...(uw[l]||[])];return db}
function toast(m,c){document.getElementById('tc').innerHTML=`<div class="toast" style="background:${c||'#22c55e'};color:#fff">${m}</div>`;setTimeout(()=>document.getElementById('tc').innerHTML='',2600)}

// === SRS ENGINE (Simplified FSRS) ===
// Card states: 0=new, 1=learning, 2=review, 3=relearning
// Intervals in minutes: [1, 10, 1440(1d), 4320(3d), 10080(7d), 21600(15d), 43200(30d), 86400(60d), 129600(90d)]
const INTERVALS=[1,10,1440,4320,10080,21600,43200,86400,129600];
const LEECH_THRESHOLD=6;
const NEW_PER_DAY=15;
const today=()=>new Date().toISOString().slice(0,10);

function getCard(l,i){
  const all=load(LS.p,{});
  return all[l+'-'+i]||{st:0,step:0,due:0,lapses:0,reps:0,ease:2.5,leech:false};
}
function saveCard(l,i,c){const all=load(LS.p,{});all[l+'-'+i]=c;save(LS.p,all)}

function reviewCard(l,i,grade){
  // grade: 1=again, 2=hard, 3=good, 4=easy
  const c=getCard(l,i);const now=Date.now();
  c.reps++;
  if(grade===1){
    c.lapses++;c.step=0;c.st=c.st>=2?3:1;
    c.due=now+INTERVALS[0]*60000;
    c.ease=Math.max(1.3,c.ease-0.2);
    if(c.lapses>=LEECH_THRESHOLD)c.leech=true;
  }else{
    if(c.st===0||c.st===1||c.st===3){
      c.step++;
      if(c.step>=2){c.st=2;c.due=now+INTERVALS[2]*60000*c.ease*(grade===4?1.3:grade===2?0.8:1);}
      else c.due=now+INTERVALS[c.step]*60000;
    }else{
      const idx=INTERVALS.findIndex(v=>v*60000*c.ease>=(c.due||0)-now+INTERVALS[2]*60000);
      const ni=Math.min(idx+1+(grade===4?1:0),INTERVALS.length-1);
      c.ease=Math.max(1.3,c.ease+(grade===4?0.15:grade===2?-0.15:0));
      c.due=now+INTERVALS[ni]*60000*c.ease;
    }
  }
  saveCard(l,i,c);return c;
}

function getDueCount(l){
  const db=getDB();const ws=db[l]||[];const now=Date.now();let due=0,nw=0;
  ws.forEach((_,i)=>{const c=getCard(l,i);if(c.st===0)nw++;else if(c.due<=now)due++});
  return{due,nw,total:ws.length};
}

function getDailyReview(){
  const db=getDB();const now=Date.now();const items=[];
  for(let l=1;l<=5;l++){if(!getUL().includes(l))continue;
    (db[l]||[]).forEach((_,i)=>{const c=getCard(l,i);if(c.st>0&&c.due<=now)items.push({l,i,c})});
  }
  items.sort((a,b)=>a.c.due-b.c.due);return items;
}

function getNewToday(l){
  const db=getDB();const ws=db[l]||[];const d=today();const all=load(LS.p,{});
  let introduced=0;const items=[];
  ws.forEach((_,i)=>{const c=all[l+'-'+i];if(!c||c.st===0){items.push(i)}else if(c.firstSeen===d)introduced++});
  return{available:items,introduced};
}

// === STREAK ===
function getStreak(){
  const data=load(LS.k,{days:{},current:0,best:0,lastDate:''});
  const d=today();
  if(data.lastDate!==d){
    const yd=new Date();yd.setDate(yd.getDate()-1);const yds=yd.toISOString().slice(0,10);
    if(data.lastDate===yds)data.current++;else if(data.lastDate)data.current=1;else data.current=1;
    data.lastDate=d;data.days[d]=0;data.best=Math.max(data.best,data.current);save(LS.k,data);
  }
  return data;
}
function addStudied(n){const data=load(LS.k,{days:{},current:0,best:0,lastDate:''});const d=today();data.days[d]=(data.days[d]||0)+n;data.lastDate=d;save(LS.k,data)}

// === SPEECH ===
let soundOn=localStorage.getItem(LS.s)!=='off';
function toggleSound(){soundOn=!soundOn;localStorage.setItem(LS.s,soundOn?'on':'off');render()}
function doSpeak(t){if(!('speechSynthesis' in window))return;speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(t);u.lang='en-US';u.rate=0.85;const v=speechSynthesis.getVoices();const p=v.find(x=>x.lang.startsWith('en')&&x.name.includes('Google'))||v.find(x=>x.lang.startsWith('en')&&!x.localService)||v.find(x=>x.lang.startsWith('en'));if(p)u.voice=p;speechSynthesis.speak(u)}
function speak(t){if(soundOn)doSpeak(t)}
if('speechSynthesis' in window){speechSynthesis.getVoices();speechSynthesis.onvoiceschanged=()=>speechSynthesis.getVoices()}

// === CONFIG ===
const MT=0.7,LN={1:'Beginner',2:'Elementary',3:'Intermediate',4:'Upper-Inter.',5:'Advanced'};
const LC={1:{bg:'from-green-400 to-emerald-500',t:'text-green-400',b:'bg-green-500'},2:{bg:'from-blue-400 to-cyan-500',t:'text-blue-400',b:'bg-blue-500'},3:{bg:'from-yellow-400 to-orange-500',t:'text-yellow-400',b:'bg-yellow-500'},4:{bg:'from-purple-400 to-violet-500',t:'text-purple-400',b:'bg-purple-500'},5:{bg:'from-red-400 to-rose-500',t:'text-red-400',b:'bg-red-500'}};
const BG='min-height:100vh;background:linear-gradient(135deg,#0f172a,#1e293b)';

function gP(l){const db=getDB();const ws=db[l]||[];if(!ws.length)return 0;return ws.filter((_,i)=>{const c=getCard(l,i);return c.st===2&&c.reps>=3}).length/ws.length}
function gS(l){const db=getDB();const ws=db[l]||[];let m=0,lrn=0,nw=0;ws.forEach((_,i)=>{const c=getCard(l,i);if(c.st===2&&c.reps>=3)m++;else if(c.st>0)lrn++;else nw++});return{m,lrn,nw,t:ws.length}}
function getUL(){const u=[1];for(let l=1;l<=4;l++)if(gP(l)>=MT)u.push(l+1);return u}

// === ANALYTICS ENGINE ===
const LS_LOG='vm2_log', LS_CONF='vm2_confusion';
function logEvent(type,data){
  const log=load(LS_LOG,[]);
  log.push({t:Date.now(),type,...data});
  // Keep last 5000 events
  if(log.length>5000)log.splice(0,log.length-5000);
  save(LS_LOG,log);
}
function logAnswer(word,level,grade,mode,responseMs,typed){
  logEvent('answer',{w:word.w,tr:word.tr,lv:level,grade,mode,ms:responseMs,typed:typed||null});
  // Track confusion pairs
  if(grade===1 && typed){
    const conf=load(LS_CONF,{});
    const key=word.w.toLowerCase();
    if(!conf[key])conf[key]={wrong:[],count:0};
    conf[key].count++;
    if(typed && typed!==word.w){
      const existing=conf[key].wrong.find(x=>x.v===typed);
      if(existing)existing.n++;else conf[key].wrong.push({v:typed,n:1});
      conf[key].wrong.sort((a,b)=>b.n-a.n);
      if(conf[key].wrong.length>5)conf[key].wrong=conf[key].wrong.slice(0,5);
    }
    save(LS_CONF,conf);
  }
}
function getAnalytics(){
  const log=load(LS_LOG,[]);const now=Date.now();const day=86400000;
  const today_start=new Date();today_start.setHours(0,0,0,0);const ts=today_start.getTime();
  const answers=log.filter(e=>e.type==='answer');
  const todayA=answers.filter(e=>e.t>=ts);
  const weekA=answers.filter(e=>e.t>=now-7*day);
  // Accuracy
  const todayAcc=todayA.length?Math.round(todayA.filter(e=>e.grade>=3).length/todayA.length*100):0;
  const weekAcc=weekA.length?Math.round(weekA.filter(e=>e.grade>=3).length/weekA.length*100):0;
  const allAcc=answers.length?Math.round(answers.filter(e=>e.grade>=3).length/answers.length*100):0;
  // Avg response time
  const avgMs=answers.length?Math.round(answers.reduce((s,e)=>s+(e.ms||0),0)/answers.length):0;
  const todayAvgMs=todayA.length?Math.round(todayA.reduce((s,e)=>s+(e.ms||0),0)/todayA.length):0;
  // Words per day (last 14 days)
  const dailyCounts={};for(let i=13;i>=0;i--){const d=new Date(now-i*day);const ds=d.toISOString().slice(0,10);dailyCounts[ds]=0}
  answers.forEach(e=>{const ds=new Date(e.t).toISOString().slice(0,10);if(dailyCounts[ds]!==undefined)dailyCounts[ds]++});
  // Accuracy by level
  const byLevel={};answers.forEach(e=>{if(!byLevel[e.lv])byLevel[e.lv]={ok:0,total:0};byLevel[e.lv].total++;if(e.grade>=3)byLevel[e.lv].ok++});
  // Hardest words (most lapses)
  const wordStats={};answers.forEach(e=>{const k=e.w;if(!wordStats[k])wordStats[k]={w:e.w,tr:e.tr,ok:0,fail:0,totalMs:0,n:0};wordStats[k].n++;wordStats[k].totalMs+=(e.ms||0);if(e.grade>=3)wordStats[k].ok++;else wordStats[k].fail++});
  const hardest=Object.values(wordStats).filter(w=>w.fail>=2).sort((a,b)=>b.fail-a.fail).slice(0,10);
  const fastest=Object.values(wordStats).filter(w=>w.n>=3).sort((a,b)=>(a.totalMs/a.n)-(b.totalMs/b.n)).slice(0,5);
  const slowest=Object.values(wordStats).filter(w=>w.n>=3).sort((a,b)=>(b.totalMs/b.n)-(a.totalMs/a.n)).slice(0,5);
  // Confusion pairs
  const conf=load(LS_CONF,{});
  const confused=Object.entries(conf).filter(([k,v])=>v.count>=2&&v.wrong.length>0).sort((a,b)=>b[1].count-a[1].count).slice(0,10);
  // Session history (last 7 days)
  const sessions=[];let cur=null;
  answers.forEach(e=>{if(!cur||e.t-cur.end>300000){if(cur)sessions.push(cur);cur={start:e.t,end:e.t,n:0,ok:0}}cur.end=e.t;cur.n++;if(e.grade>=3)cur.ok++});
  if(cur)sessions.push(cur);
  const recentSessions=sessions.filter(s=>s.start>=now-7*day).slice(-10);
  return{todayA:todayA.length,weekA:weekA.length,allA:answers.length,todayAcc,weekAcc,allAcc,avgMs,todayAvgMs,dailyCounts,byLevel,hardest,fastest,slowest,confused,recentSessions,totalEvents:log.length};
}

// Response timer
let cardShownAt=0;

// === STATE ===
let S={sc:'levels',cL:1,cI:0,sA:false,sH:false,sQ:[],sR:[],sM:null,typed:'',cOpts:[],cAns:null,readRaw:'',sentenceResult:null};
let touchX=0;

// === BUILD STUDY QUEUE ===
function buildQueue(lv,mode){
  const db=getDB();const ws=db[lv]||[];const now=Date.now();let q=[];
  if(mode==='daily'){
    const items=getDailyReview();q=items.map(x=>({w:db[x.l][x.i][0],tr:db[x.l][x.i][1],ex:db[x.l][x.i][2],h:db[x.l][x.i][3],lv:x.l,i:x.i,mode:0}));
    if(q.length>30)q=q.slice(0,30);
  }else{
    const due=[];const nw=[];const lrn=[];
    ws.forEach((w,i)=>{const c=getCard(lv,i);const item={w:w[0],tr:w[1],ex:w[2],h:w[3],lv,i,mode:0};
      if(c.st===0)nw.push(item);else if(c.due<=now)due.push(item);else if(c.st===1||c.st===3)lrn.push(item)});
    // Mix: due first, then learning, then new (limited)
    const nt=getNewToday(lv);const newLimit=Math.max(0,NEW_PER_DAY-nt.introduced);
    if(mode==='new')q=nw.slice(0,Math.min(20,newLimit));
    else if(mode==='due')q=due.slice(0,30);
    else{q=[...due,...lrn,...nw.slice(0,Math.min(10,newLimit))];if(q.length>25)q=q.slice(0,25)}
  }
  return q;
}

function go(lv,mode){
  const q=buildQueue(lv,mode);if(!q.length){toast('–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è','#6366f1');return}
  logEvent('session_start',{lv,mode:mode||'mix',cards:q.length});
  S.sQ=q;S.cI=0;S.sA=false;S.sH=false;S.sR=[];S.cL=lv;S.sM=null;S.sc='study';S.typed='';S.cOpts=[];S.cAns=null;render();
}
function goDaily(){
  const items=getDailyReview();if(!items.length){toast('–í—Å–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–¥–µ–ª–∞–Ω—ã! üéâ','#6366f1');return}
  const db=getDB();const q=items.slice(0,30).map(x=>({w:db[x.l][x.i][0],tr:db[x.l][x.i][1],ex:db[x.l][x.i][2],h:db[x.l][x.i][3],lv:x.l,i:x.i,mode:0}));
  S.sQ=q;S.cI=0;S.sA=false;S.sH=false;S.sR=[];S.cL=0;S.sM=null;S.sc='study';S.typed='';S.cOpts=[];S.cAns=null;render();
}

function trainConfused(){
  const conf=load(LS_CONF,{});const db=getDB();const q=[];
  const confWords=Object.entries(conf).filter(([k,v])=>v.count>=2).sort((a,b)=>b[1].count-a[1].count).slice(0,20);
  // Find these words in DB
  for(const [word,data] of confWords){
    for(let l=1;l<=5;l++){const ws=db[l]||[];
      const idx=ws.findIndex(w=>w[0].toLowerCase()===word);
      if(idx!==-1){
        // Add in multiple modes for better drilling
        q.push({w:ws[idx][0],tr:ws[idx][1],ex:ws[idx][2],h:ws[idx][3],lv:l,i:idx,mode:0});
        q.push({w:ws[idx][0],tr:ws[idx][1],ex:ws[idx][2],h:ws[idx][3],lv:l,i:idx,mode:2});
        q.push({w:ws[idx][0],tr:ws[idx][1],ex:ws[idx][2],h:ws[idx][3],lv:l,i:idx,mode:3});
        break;
      }
    }
  }
  if(!q.length){toast('–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª–æ–≤','#6366f1');return}
  // Shuffle
  for(let i=q.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[q[i],q[j]]=[q[j],q[i]]}
  S.sQ=q.slice(0,30);S.cI=0;S.sA=false;S.sH=false;S.sR=[];S.cL=0;S.sM=null;S.sc='study';S.typed='';S.cOpts=[];S.cAns=null;
  toast('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª–æ–≤ üéØ');render();
}

function getRandChoices(cW){
  const db=getDB();const ws=db[cW.lv]||[];const others=ws.filter(w=>w[1]!==cW.tr).sort(()=>Math.random()-.5).slice(0,3);
  const opts=others.map(w=>w[1]);opts.push(cW.tr);return opts.sort(()=>Math.random()-.5);
}

function ans(grade){
  const cW=S.sQ[S.cI];if(!cW)return;
  const responseMs=Date.now()-cardShownAt;
  const c=reviewCard(cW.lv,cW.i,grade);
  if(!c.firstSeen)c.firstSeen=today();saveCard(cW.lv,cW.i,c);
  logAnswer(cW,cW.lv,grade,cW.mode,responseMs,S.typed||null);
  S.sR.push({...cW,ok:grade>=3});addStudied(1);
  if(grade===1){const nm=(cW.mode+1)%5;const at=Math.min(S.cI+3+Math.floor(Math.random()*3),S.sQ.length);S.sQ.splice(at,0,{...cW,mode:nm})}
  const card=document.getElementById('card');if(card)card.className='rounded-2xl p-6 text-center transition-all '+(grade>=3?'ag':'ar');
  S.typed='';S.cAns=null;S.cOpts=[];S.sentenceResult=null;
  setTimeout(()=>{if(S.cI+1<S.sQ.length){S.cI++;S.sA=false;S.sH=false;render();}else{S.sc='results';render();}},500);
}
function checkChoice(val){const cW=S.sQ[S.cI];S.cAns=val;S.typed=val;S.sA=true;render();setTimeout(()=>ans(val===cW.tr?3:1),600)}
function checkTyped(){const cW=S.sQ[S.cI];const v=(document.getElementById('ti')||{}).value||'';S.typed=v;S.sA=true;render();setTimeout(()=>ans(v.toLowerCase().trim()===cW.w.toLowerCase().trim()?3:1),800)}

// === EXPORT/IMPORT ===
function exportData(){
  const data={progress:load(LS.p,{}),userWords:loadUW(),streak:load(LS.k,{}),version:2,date:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='vocabmaster-backup-'+today()+'.json';a.click();toast('–≠–∫—Å–ø–æ—Ä—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!')
}
function importData(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';
  inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{
    try{const d=JSON.parse(ev.target.result);if(d.progress)save(LS.p,d.progress);if(d.userWords)save(LS.u,d.userWords);if(d.streak)save(LS.k,d.streak);
    toast('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω! –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');render()}catch(e){toast('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞!','#ef4444')}};r.readAsText(f)};inp.click()
}

// === ADD WORDS ===
function addSingle(){
  const w=document.getElementById('aw-w').value.trim(),t=document.getElementById('aw-t').value.trim();
  const e=document.getElementById('aw-e').value.trim()||w+'.',h=document.getElementById('aw-h').value.trim()||t.split(' ')[0];
  const l=+document.getElementById('aw-l').value;
  if(!w||!t){toast('–ó–∞–ø–æ–ª–Ω–∏ —Å–ª–æ–≤–æ –∏ –ø–µ—Ä–µ–≤–æ–¥!','#ef4444');return}
  const uw=loadUW();uw[l].push([w,t,e,h]);save(LS.u,uw);toast('+1: '+w);
  ['aw-w','aw-t','aw-e','aw-h'].forEach(id=>document.getElementById(id).value='');
}
function importBulk(){
  const txt=document.getElementById('imp-txt').value.trim(),l=+document.getElementById('imp-l').value;
  if(!txt){toast('–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç!','#ef4444');return}
  const uw=loadUW();let n=0;
  txt.split('\n').filter(x=>x.trim()).forEach(line=>{
    let p;if(line.includes(';'))p=line.split(';');else if(line.includes('\t'))p=line.split('\t');else if(line.includes(' - '))p=line.split(' - ');else if(line.includes(' ‚Äî '))p=line.split(' ‚Äî ');else return;
    p=p.map(x=>x.trim());if(p.length>=2){uw[l].push([p[0],p[1],p[2]||p[0]+'.',p[3]||p[1].split(' ')[0]]);n++}
  });save(LS.u,uw);toast('+'+n+' —Å–ª–æ–≤');document.getElementById('imp-txt').value='';
}

// === PARSE TEXT ===
const STOP=new Set('i me my we our you your he him his she her it its they them their a an the this that is am are was were be been have has had do does did will would shall should can could may might must to of in for on with at by from as into about through during before after above below up down and but or not no so if then than too very just also still even now here there where when how what which who why all each every both few more most other some such only own same well back get got go went come came make made take took see saw know knew think say said tell told give gave find found let put seem show try ask use call keep much many way thing man day time year people world life part place week point right left while because since until although though once us'.split(' '));
let parsed=[];
function parseText(){
  const txt=document.getElementById('pt-txt').value.trim();if(!txt){toast('–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç!','#ef4444');return}
  const db=getDB();const exist=new Set();Object.values(db).forEach(l=>l.forEach(w=>exist.add(w[0].toLowerCase())));
  const raw=txt.toLowerCase().replace(/[^a-z\s'-]/g,' ').split(/\s+/).filter(w=>w.length>=3&&/^[a-z]/.test(w));
  let unique=[...new Set(raw)].filter(w=>!STOP.has(w)&&!exist.has(w));
  if(!unique.length){document.getElementById('pt-res').innerHTML='<div class="text-slate-500 text-sm text-center mt-3">–ù–æ–≤—ã—Ö —Å–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return}
  document.getElementById('pt-btn').textContent='‚è≥...';document.getElementById('pt-btn').disabled=true;
  const batches=[];for(let i=0;i<unique.length;i+=10)batches.push(unique.slice(i,i+10));
  parsed=[];
  Promise.all(batches.map(b=>{
    return fetch('https://api.mymemory.translated.net/get?q='+encodeURIComponent(b.join(' | '))+'&langpair=en|ru')
      .then(r=>r.json()).then(d=>{const tr=(d.responseData.translatedText||'').split(' | ');
      b.forEach((w,i)=>{const t=(tr[i]||'').trim().toLowerCase();parsed.push({w,tr:t&&t!==w?t:'???',on:t&&t!==w})})}).catch(()=>b.forEach(w=>parsed.push({w,tr:'???',on:false})))
  })).then(()=>{document.getElementById('pt-btn').textContent='üîç –ò–∑–≤–ª–µ—á—å';document.getElementById('pt-btn').disabled=false;showParsed()});
}
function showParsed(){
  let h='<div class="mt-2 max-h-60 overflow-y-auto space-y-1">';
  parsed.forEach((p,i)=>{h+=`<div class="flex items-center gap-2 py-1 border-b border-slate-700/30"><input type="checkbox" ${p.on?'checked':''} onchange="parsed[${i}].on=this.checked" class="shrink-0 accent-green-500"><span class="text-white text-sm flex-1">${p.w}</span><input value="${p.tr}" onchange="parsed[${i}].tr=this.value" class="w-28 text-xs py-1 px-2" style="background:#0f172a;border:1px solid #334155;border-radius:6px"></div>`});
  h+='</div><button onclick="addParsed()" class="w-full mt-3 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold active:scale-95">–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>';
  document.getElementById('pt-res').innerHTML=h;
}
function addParsed(){
  const l=+document.getElementById('pt-l').value;const uw=loadUW();let n=0;
  parsed.filter(p=>p.on&&p.tr!=='???').forEach(p=>{uw[l].push([p.w,p.tr,p.w+'.',p.tr.split(' ')[0]]);n++});
  save(LS.u,uw);toast('+'+n+' —Å–ª–æ–≤');parsed=[];document.getElementById('pt-res').innerHTML='';document.getElementById('pt-txt').value='';
}

// === RENDER ===
function render(){
  const a=document.getElementById('app');const uL=getUL();const db=getDB();const streak=getStreak();
  const totalDue=getDailyReview().length;

  // ONBOARDING INTRO
  if(S.sc==='onboard_intro'){
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto text-center" style="padding-top:15vh">
    <div class="text-6xl mb-6">üìö</div>
    <h1 class="text-3xl font-bold text-white mb-3">VocabMaster</h1>
    <p class="text-slate-400 mb-8">–£–º–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ —Å AI, –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ–º –∏ –º–∏–Ω–∏-–∏–≥—Ä–∞–º–∏</p>
    <button onclick="startOnboarding()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold text-lg shadow-lg active:scale-95 mb-3">üéØ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–π —É—Ä–æ–≤–µ–Ω—å</button>
    <button onclick="save('vm2_onboarded',true);S.sc='levels';render()" class="w-full py-3 rounded-xl bg-slate-800 text-slate-400 text-sm">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç ‚Üí</button>
    </div></div>`;return}

  // ONBOARDING
  if(S.sc==='onboard'){
    if(!onboard.done){
      const w=ONBOARD_WORDS[onboard.idx];const pct=Math.round((onboard.idx/ONBOARD_WORDS.length)*100);
      a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto text-center">
      <h2 class="text-xl font-bold text-white mb-2">üéØ –û–ø—Ä–µ–¥–µ–ª–∏–º —Ç–≤–æ–π —É—Ä–æ–≤–µ–Ω—å</h2>
      <p class="text-slate-400 text-xs mb-4">–ó–Ω–∞–µ—à—å –ª–∏ —Ç—ã –ø–µ—Ä–µ–≤–æ–¥ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞?</p>
      <div class="h-1.5 bg-slate-700 rounded-full mb-6 overflow-hidden"><div class="h-full bg-gradient-to-r from-green-400 to-indigo-500 rounded-full" style="width:${pct}%"></div></div>
      <div class="text-slate-500 text-xs mb-2">${onboard.idx+1}/${ONBOARD_WORDS.length}</div>
      <div class="bg-slate-800 rounded-2xl p-8 mb-6">
        <div class="text-4xl font-bold text-white mb-2">${w[0]}</div>
        <button onclick="doSpeak('${w[0]}')" class="text-blue-400 text-2xl mb-4 active:scale-90">üîä</button>
        <div class="text-slate-500 text-xs">–£—Ä–æ–≤–µ–Ω—å ${w[2]} ‚Äî ${LN[w[2]]}</div>
      </div>
      <div class="flex gap-3">
        <button onclick="onboardAnswer(false)" class="flex-1 py-4 rounded-xl bg-red-500/20 border border-red-500/50 text-red-400 font-bold text-lg active:scale-95">–ù–µ –∑–Ω–∞—é</button>
        <button onclick="onboardAnswer(true)" class="flex-1 py-4 rounded-xl bg-green-500/20 border border-green-500/50 text-green-400 font-bold text-lg active:scale-95">–ó–Ω–∞—é ‚úì</button>
      </div>
      </div></div>`;
    }else{
      let lvlResults='';for(let l=1;l<=5;l++){const s=onboard.byLv[l];if(!s)continue;const pct=Math.round(s.ok/s.n*100);
        lvlResults+=`<div class="flex items-center gap-2 mb-1"><span class="text-slate-400 text-xs w-8">–£—Ä.${l}</span><div class="flex-1 h-3 bg-slate-700 rounded-full overflow-hidden"><div class="h-full ${LC[l].b} rounded-full" style="width:${pct}%"></div></div><span class="text-white text-xs w-10 text-right">${pct}%</span></div>`}
      a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto text-center">
      <div class="text-5xl mb-4">üéâ</div>
      <h2 class="text-2xl font-bold text-white mb-2">–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</h2>
      <div class="bg-slate-800 rounded-2xl p-6 mt-4">
        <div class="text-slate-400 text-sm mb-2">–¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å:</div>
        <div class="text-4xl font-bold text-white mb-1">${onboard.suggestedLevel}</div>
        <div class="text-indigo-400 font-semibold">${LN[onboard.suggestedLevel]}</div>
        <div class="mt-4 text-left">${lvlResults}</div>
      </div>
      <button onclick="S.sc='levels';render()" class="w-full mt-6 py-4 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold text-lg shadow-lg active:scale-95">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ! üöÄ</button>
      </div></div>`;
    }
    return}

  // ACHIEVEMENTS
  if(S.sc==='badges'){
    const unlocked=getUnlockedBadges();const uIds=new Set(unlocked.map(b=>b.id));
    let cards='';BADGES.forEach(b=>{const got=uIds.has(b.id);
      cards+=`<div class="flex items-center gap-3 py-3 border-b border-slate-700/30 ${got?'':'opacity-40'}">
        <div class="text-3xl ${got?'':'grayscale'}">${b.icon}</div>
        <div class="flex-1"><div class="text-white text-sm font-semibold">${b.name}</div><div class="text-slate-400 text-xs">${b.desc}</div></div>
        ${got?'<span class="text-green-400 text-xs">‚úÖ</span>':'<span class="text-slate-600 text-xs">üîí</span>'}
      </div>`});
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <button onclick="S.sc='levels';render()" class="text-slate-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
    <h2 class="text-xl font-bold text-white mb-1">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
    <p class="text-slate-400 text-xs mb-4">${unlocked.length}/${BADGES.length} –æ—Ç–∫—Ä—ã—Ç–æ</p>
    <div class="h-2 bg-slate-700 rounded-full overflow-hidden mb-4"><div class="h-full bg-gradient-to-r from-amber-400 to-yellow-500 rounded-full" style="width:${(unlocked.length/BADGES.length)*100}%"></div></div>
    <div class="bg-slate-800 rounded-xl p-4">${cards}</div>
    </div></div>`;return}

  // MINI-GAMES
  if(S.sc==='games'){
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <button onclick="S.sc='levels';render()" class="text-slate-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
    <h2 class="text-xl font-bold text-white mb-4">üéÆ –ú–∏–Ω–∏-–∏–≥—Ä—ã</h2>
    <div class="space-y-3">
      <button onclick="startGame('match')" class="w-full bg-slate-800 hover:bg-slate-700 rounded-xl p-4 text-left">
        <div class="text-white font-semibold">üîó Word Match</div>
        <div class="text-slate-400 text-xs">–°–æ–µ–¥–∏–Ω–∏ —Å–ª–æ–≤–∞ —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏. 60 —Å–µ–∫.</div></button>
      <button onclick="startGame('scramble')" class="w-full bg-slate-800 hover:bg-slate-700 rounded-xl p-4 text-left">
        <div class="text-white font-semibold">üîÄ Word Scramble</div>
        <div class="text-slate-400 text-xs">–°–æ–±–µ—Ä–∏ —Å–ª–æ–≤–æ –∏–∑ –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã—Ö –±—É–∫–≤.</div></button>
      <button onclick="startGame('speed')" class="w-full bg-slate-800 hover:bg-slate-700 rounded-xl p-4 text-left">
        <div class="text-white font-semibold">‚ö° Speed Round</div>
        <div class="text-slate-400 text-xs">–°–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ –∑–∞ 60 —Å–µ–∫—É–Ω–¥?</div></button>
    </div></div></div>`;return}

  // GAME SCREEN
  if(S.sc==='game'){
    const isEnd=game.type.endsWith('_end');const baseType=game.type.replace('_end','');

    if(isEnd){
      checkNewBadges();
      a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto text-center">
      <div class="text-5xl mb-4">üèÜ</div><h2 class="text-2xl font-bold text-white mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç!</h2>
      <div class="bg-slate-800 rounded-2xl p-8 mt-4"><div class="text-5xl font-bold text-amber-400 mb-2">${game.score}</div><div class="text-slate-400">–æ—á–∫–æ–≤</div>
      ${baseType==='speed'?`<div class="text-white mt-2">${game.roundIdx} —Å–ª–æ–≤ –∑–∞ 60 —Å–µ–∫</div>`:''}</div>
      <div class="flex gap-3 mt-6"><button onclick="startGame('${baseType}')" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-semibold active:scale-95">üîÑ –ï—â—ë</button><button onclick="S.sc='games';render()" class="flex-1 py-3 rounded-xl bg-slate-700 text-white font-semibold active:scale-95">üéÆ –ò–≥—Ä—ã</button></div>
      </div></div>`;return;
    }

    // Match game
    if(baseType==='match'){
      const cards=game.pairs.map(p=>{const done=game.matched.includes(p.id);const sel=game.selected&&game.selected.id===p.id;
        return`<button onclick="${done?'':`selectCard('${p.id}')`}" class="py-2 px-3 rounded-lg text-sm font-medium transition-all ${done?'bg-green-900/40 text-green-400 opacity-50':sel?'bg-indigo-600 text-white ring-2 ring-indigo-400':'bg-slate-700 text-white hover:bg-slate-600'} ${p.type==='trans'?'italic':''}">${p.text}</button>`}).join('');
      a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
      <div class="flex items-center justify-between mb-4"><button onclick="clearInterval(game.timerRef);S.sc='games';render()" class="text-slate-400 text-sm">‚Üê –ù–∞–∑–∞–¥</button><div class="text-white font-bold">üîó Match</div><div class="flex gap-3"><span class="text-amber-400 text-sm">‚òÖ${game.score}</span><span class="text-slate-400 text-sm">${game.timer}s</span></div></div>
      <div class="grid grid-cols-3 gap-2">${cards}</div>
      </div></div>`;return;
    }

    // Scramble game
    if(baseType==='scramble'){
      const w=game.roundWords[game.roundIdx];if(!w){endGame();return}
      a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto text-center">
      <div class="flex items-center justify-between mb-4"><button onclick="S.sc='games';render()" class="text-slate-400 text-sm">‚Üê</button><div class="text-white font-bold">üîÄ Scramble</div><div class="flex gap-3"><span class="text-amber-400 text-sm">‚òÖ${game.score}</span><span class="text-slate-400 text-sm">${game.roundIdx+1}/${game.roundWords.length}</span></div></div>
      <div class="bg-slate-800 rounded-2xl p-6 mb-4">
        <div class="text-cyan-300 text-sm mb-3">${w.tr}</div>
        <div class="text-4xl font-bold text-white mb-4 tracking-widest font-mono">${game.scramble.split('').map(c=>`<span class="inline-block mx-1 bg-slate-700 rounded px-2 py-1">${c}</span>`).join('')}</div>
        <input id="scramble-input" type="text" placeholder="Type the word..." class="text-center text-lg mb-3" autocomplete="off" autocapitalize="none" spellcheck="false" onkeydown="if(event.key==='Enter')checkScramble()">
        <button onclick="checkScramble()" class="w-full py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-semibold active:scale-95">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <div class="text-slate-500 text-xs mt-2">–ü–æ–ø—ã—Ç–∫–∞ ${game.attempts+1}/3</div>
      </div></div></div>`;
      setTimeout(()=>{const i=document.getElementById('scramble-input');if(i)i.focus()},100);return;
    }

    // Speed round
    if(baseType==='speed'){
      const w=game.roundWords[game.roundIdx];if(!w){endGame();return}
      a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto text-center">
      <div class="flex items-center justify-between mb-4"><button onclick="clearInterval(game.timerRef);S.sc='games';render()" class="text-slate-400 text-sm">‚Üê</button><div class="text-white font-bold">‚ö° Speed</div><div class="flex gap-3"><span class="text-amber-400 text-sm">‚òÖ${game.score}</span><span class="${game.timer<=10?'text-red-400':'text-slate-400'} text-sm font-mono">${game.timer}s</span></div></div>
      <div class="bg-slate-800 rounded-2xl p-6 mb-4">
        <div class="text-4xl font-bold text-white mb-3">${w.w}</div>
        <button onclick="doSpeak('${w.w}')" class="text-blue-400 text-2xl mb-4 active:scale-90">üîä</button>
        <div class="text-xl text-cyan-300 mb-6">${w.tr}?</div>
        <div class="flex gap-3">
          <button onclick="speedAnswer(false)" class="flex-1 py-4 rounded-xl bg-red-500/20 border border-red-500/50 text-red-400 font-bold text-xl active:scale-95">‚úó</button>
          <button onclick="speedAnswer(true)" class="flex-1 py-4 rounded-xl bg-green-500/20 border border-green-500/50 text-green-400 font-bold text-xl active:scale-95">‚úì</button>
        </div>
      </div></div></div>`;return;
    }
  }

  // AUDIO MODE
  if(S.sc==='audio'){
    const item=audioQueue[audioIdx]||audioQueue[audioQueue.length-1];
    const pct=audioQueue.length?Math.round(((audioIdx+1)/audioQueue.length)*100):0;
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto text-center">
    <div class="flex items-center justify-between mb-6"><button onclick="stopAudio()" class="text-slate-400 text-sm">‚úï –°—Ç–æ–ø</button><div class="text-white font-semibold">üéß –ê—É–¥–∏–æ</div><div class="text-slate-400 text-sm">${audioIdx+1}/${audioQueue.length}</div></div>
    <div class="h-1.5 bg-slate-700 rounded-full mb-8 overflow-hidden"><div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all" style="width:${pct}%"></div></div>
    <div class="bg-slate-800 rounded-2xl p-8 mb-6">
      <div class="text-5xl font-bold text-white mb-4">${item?item.w:'...'}</div>
      <div class="text-2xl text-cyan-300 mb-2">${item?item.tr:''}</div>
      <div class="text-slate-400 text-sm italic">${item?item.ex:''}</div>
    </div>
    <div class="flex justify-center gap-4 mb-6">
      <button onclick="audioBack()" class="w-14 h-14 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-2xl active:scale-90">‚èÆ</button>
      <button onclick="toggleAudioPause()" class="w-16 h-16 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-3xl text-white shadow-lg active:scale-90">${audioPaused?'‚ñ∂Ô∏è':'‚è∏'}</button>
      <button onclick="audioSkip()" class="w-14 h-14 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-2xl active:scale-90">‚è≠</button>
    </div>
    <div class="text-slate-500 text-xs">–°–ª—É—à–∞–π –∏ –∑–∞–ø–æ–º–∏–Ω–∞–π. –ú–æ–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Ä–∞–Ω.</div>
    </div></div>`;return}

  // TOPICS
  if(S.sc==='topics'){
    let cards='';
    Object.entries(TOPICS).forEach(([name,words])=>{
      const db=getDB();let known=0,total=0;
      words.forEach(w=>{for(let l=1;l<=5;l++){const ws=db[l]||[];const idx=ws.findIndex(x=>x[0].toLowerCase()===w);
        if(idx!==-1){total++;const c=getCard(l,idx);if(c.st===2&&c.reps>=3)known++;break}}});
      const pct=total?Math.round(known/total*100):0;
      cards+=`<button onclick="goTopic('${name}')" class="bg-slate-800 hover:bg-slate-700 rounded-xl p-3 text-left transition-all">
        <div class="flex items-center justify-between mb-1"><span class="text-white font-semibold text-sm">${name}</span><span class="text-slate-400 text-xs">${known}/${total}</span></div>
        <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-indigo-500 rounded-full" style="width:${pct}%"></div></div>
      </button>`;
    });
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <button onclick="S.sc='levels';render()" class="text-slate-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
    <h2 class="text-xl font-bold text-white mb-4">üè∑ –¢–µ–º—ã</h2>
    <div class="grid grid-cols-2 gap-3">${cards}</div>
    </div></div>`;return}

  // AI TUTOR
  if(S.sc==='tutor'){
    const cfg=getAIConfig();const hasKey=!!cfg.key;
    const chatHtml=tutorChat.map(m=>{
      if(m.role==='user')return`<div class="flex justify-end mb-2"><div class="bg-indigo-600 rounded-2xl rounded-br-sm px-4 py-2 max-w-xs"><div class="text-white text-sm">${m.text}</div></div></div>`;
      return`<div class="flex justify-start mb-2"><div class="bg-slate-800 rounded-2xl rounded-bl-sm px-4 py-2 max-w-xs"><div class="text-slate-200 text-sm leading-relaxed">${m.loading?'<span class="animate-pulse">‚è≥ –î—É–º–∞—é...</span>':formatAIText(m.text)}</div></div></div>`;
    }).join('');
    const wordHeader=tutorWord?`<div class="bg-slate-800 rounded-xl p-3 mb-3 flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br ${(LC[tutorWord.lv]||LC[1]).bg} flex items-center justify-center text-white font-bold">${tutorWord.lv||'?'}</div>
      <div class="flex-1"><div class="text-white font-bold text-lg">${tutorWord.w} <button onclick="doSpeak('${tutorWord.w}')" class="text-blue-400 text-base">üîä</button></div><div class="text-cyan-300 text-sm">${tutorWord.tr}</div></div>
    </div>`:'';

    a.innerHTML=`<div style="${BG}" class="p-4 pb-24"><div class="max-w-md mx-auto">
    <button onclick="S.sc='levels';render()" class="text-slate-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
    <h2 class="text-xl font-bold text-white mb-3">ü§ñ AI –¢—å—é—Ç–æ—Ä</h2>
    ${!hasKey?`<div class="bg-amber-900/30 border border-amber-500/30 rounded-xl p-4 mb-4">
      <div class="text-amber-400 font-semibold text-sm mb-2">–ù—É–∂–µ–Ω API –∫–ª—é—á</div>
      <div class="text-slate-400 text-xs mb-3">–ü–æ–ª—É—á–∏ –∫–ª—é—á –Ω–∞ <a href="https://console.anthropic.com" target="_blank" class="text-blue-400 underline">console.anthropic.com</a></div>
      <input id="ai-key-input" type="password" placeholder="sk-ant-..." class="mb-2 text-sm" value="${cfg.key}">
      <button onclick="const c=getAIConfig();c.key=document.getElementById('ai-key-input').value.trim();saveAIConfig(c);render()" class="w-full py-2 rounded-xl bg-amber-500 text-white font-semibold text-sm active:scale-95">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>`:''}
    ${wordHeader}
    ${tutorWord?`<div class="flex flex-wrap gap-2 mb-4">
      <button onclick="tutorAsk('explain')" class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-white text-xs active:scale-95">üìù –û–±—ä—è—Å–Ω–∏</button>
      <button onclick="tutorAsk('mnemonic')" class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-white text-xs active:scale-95">üß† –ú–Ω–µ–º–æ–Ω–∏–∫–∞</button>
      <button onclick="tutorAsk('examples')" class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-white text-xs active:scale-95">üí¨ –ü—Ä–∏–º–µ—Ä—ã</button>
      <button onclick="tutorAsk('difference')" class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-white text-xs active:scale-95">üîÄ –†–∞–∑–Ω–∏—Ü–∞</button>
      <button onclick="tutorAsk('usage')" class="px-3 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-white text-xs active:scale-95">üó£ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
    </div>`:''}
    <div id="tutor-chat" class="mb-4 max-h-96 overflow-y-auto">${chatHtml}</div>
    </div></div>
    <div class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-700 p-3 z-50"><div class="max-w-md mx-auto flex gap-2">
      <input id="tutor-input" placeholder="${tutorWord?'–°–ø—Ä–æ—Å–∏ –ø—Ä–æ '+tutorWord.w+'...':'–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å...'}" class="flex-1 text-sm py-2" onkeydown="if(event.key==='Enter')tutorCustom()">
      <button onclick="tutorCustom()" class="py-2 px-4 rounded-xl bg-indigo-600 text-white font-semibold text-sm active:scale-95">‚Üí</button>
    </div></div>`;
    // Scroll chat to bottom
    setTimeout(()=>{const ch=document.getElementById('tutor-chat');if(ch)ch.scrollTop=ch.scrollHeight},100);
    return}

  // READING MODE
  if(S.sc==='read'){
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <button onclick="S.sc='levels';render()" class="text-slate-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
    <h2 class="text-xl font-bold text-white mb-2">üìñ –†–µ–∂–∏–º —á—Ç–µ–Ω–∏—è</h2>
    <p class="text-slate-400 text-xs mb-3">–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç ‚Äî —Å–ª–æ–≤–∞ –ø–æ–¥—Å–≤–µ—Ç—è—Ç—Å—è –ø–æ —É—Ä–æ–≤–Ω—é –∑–Ω–∞–Ω–∏—è. –ù–∞–∂–º–∏ –Ω–∞ —Å–ª–æ–≤–æ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</p>
    <textarea id="read-input" rows="5" placeholder="Paste any English text here...">${S.readRaw||''}</textarea>
    <div class="flex gap-2 mt-2 mb-3">
      <button onclick="analyzeText()" class="flex-1 py-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-semibold text-sm active:scale-95">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
      <button onclick="document.getElementById('read-input').value='';S.readRaw='';document.getElementById('read-out').innerHTML='';document.getElementById('read-stats').innerHTML=''" class="py-2 px-4 rounded-xl bg-slate-800 text-slate-400 text-sm active:scale-95">‚úï</button>
    </div>
    <div class="flex flex-wrap gap-2 mb-3 text-xs">
      <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-green-500/60"></span> –ó–Ω–∞—é</span>
      <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-yellow-500/60"></span> –£—á—É</span>
      <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-500/60"></span> –ù–µ –∑–Ω–∞—é</span>
      <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-slate-700"></span> –°—Ç–æ–ø-—Å–ª–æ–≤–∞</span>
    </div>
    <div id="read-stats" class="mb-3"></div>
    <div id="read-out" class="bg-slate-800 rounded-xl p-4 text-sm leading-relaxed min-h-16"></div>
    <div id="read-popup" style="display:none" class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-700 p-4 z-50">
      <div class="max-w-md mx-auto">
        <div class="flex items-center justify-between mb-2">
          <div><span id="rp-word" class="text-white font-bold text-lg"></span> <button onclick="doSpeak(document.getElementById('rp-word').textContent)" class="text-blue-400 text-lg">üîä</button></div>
          <button onclick="document.getElementById('read-popup').style.display='none'" class="text-slate-400 text-xl">‚úï</button>
        </div>
        <div id="rp-trans" class="text-cyan-300 mb-2"></div>
        <div id="rp-status" class="text-slate-400 text-xs mb-3"></div>
        <div class="flex gap-2">
          <select id="rp-level" class="flex-1 text-sm py-2"><option value="1">1 Beginner</option><option value="2" selected>2 Elementary</option><option value="3">3 Intermediate</option><option value="4">4 Upper-Int.</option><option value="5">5 Advanced</option></select>
          <button onclick="addFromReader()" id="rp-add-btn" class="py-2 px-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold text-sm active:scale-95">‚ûï</button>
          <button onclick="if(pendingReadWord){openTutor(pendingReadWord.w,pendingReadWord.autoTr||pendingReadWord.tr||'?','',2);document.getElementById('read-popup').style.display='none'}" class="py-2 px-3 rounded-xl bg-purple-600 text-white font-semibold text-sm active:scale-95">ü§ñ</button>
        </div>
      </div>
    </div>
    </div></div>`;return}

  // ANALYTICS DASHBOARD
  if(S.sc==='analytics'){
    const an=getAnalytics();
    // Daily chart (bars)
    const dc=an.dailyCounts;const dcKeys=Object.keys(dc);const dcMax=Math.max(...Object.values(dc),1);
    let bars='';dcKeys.forEach(d=>{const v=dc[d];const h=Math.max(2,Math.round(v/dcMax*80));const isToday=d===today();
      bars+=`<div class="flex flex-col items-center gap-1" title="${d}: ${v}"><div class="w-4 rounded-t ${isToday?'bg-amber-400':'bg-indigo-500'}" style="height:${h}px"></div><div class="text-slate-600 text-xs" style="font-size:8px;writing-mode:vertical-lr">${d.slice(5)}</div></div>`});
    // Level accuracy
    let lvlBars='';for(let l=1;l<=5;l++){const s=an.byLevel[l];if(!s)continue;const acc=Math.round(s.ok/s.total*100);const c=LC[l];
      lvlBars+=`<div class="flex items-center gap-2 mb-1"><span class="text-slate-400 text-xs w-6">–£—Ä.${l}</span><div class="flex-1 h-4 bg-slate-700 rounded-full overflow-hidden"><div class="h-full ${c.b} rounded-full" style="width:${acc}%"></div></div><span class="text-slate-400 text-xs w-10 text-right">${acc}%</span></div>`}
    // Hardest words
    let hardList='';an.hardest.forEach(w=>{const acc=w.n?Math.round(w.ok/w.n*100):0;
      hardList+=`<div class="flex items-center justify-between py-1 border-b border-slate-700/30"><div><span class="text-white text-sm">${w.w}</span> <span class="text-slate-500 text-xs">${w.tr}</span></div><div class="flex items-center gap-2"><button onclick="openTutor('${w.w}','${(w.tr||'').replace(/'/g,"\\'")}','',0)" class="text-purple-400 text-xs">ü§ñ</button><span class="text-red-400 text-xs">${w.fail}err</span><span class="text-slate-500 text-xs">${acc}%</span></div></div>`});
    // Confused pairs
    let confList='';an.confused.forEach(([word,data])=>{
      confList+=`<div class="py-2 border-b border-slate-700/30"><div class="flex items-center justify-between"><span class="text-white text-sm font-semibold">${word}</span><span class="text-red-400 text-xs">${data.count} –æ—à–∏–±–æ–∫</span></div><div class="flex flex-wrap gap-1 mt-1">${data.wrong.map(w=>`<span class="bg-red-900/30 text-red-300 text-xs px-2 py-0.5 rounded-full">${w.v} (${w.n}x)</span>`).join('')}</div></div>`});
    // Sessions
    let sessList='';an.recentSessions.reverse().forEach(s=>{const d=new Date(s.start);const acc=s.n?Math.round(s.ok/s.n*100):0;const dur=Math.round((s.end-s.start)/60000);
      sessList+=`<div class="flex items-center justify-between py-1 border-b border-slate-700/30"><span class="text-slate-400 text-xs">${d.toLocaleDateString()} ${d.toLocaleTimeString().slice(0,5)}</span><div class="flex items-center gap-2"><span class="text-white text-xs">${s.n} —Å–ª–æ–≤</span><span class="${acc>=70?'text-green-400':'text-amber-400'} text-xs">${acc}%</span><span class="text-slate-500 text-xs">${dur}–º–∏–Ω</span></div></div>`});
    // Response time: fastest/slowest
    let speedList='';an.fastest.forEach(w=>{const avg=Math.round(w.totalMs/w.n/1000*10)/10;speedList+=`<span class="bg-green-900/30 text-green-300 text-xs px-2 py-1 rounded-full">${w.w} ${avg}s</span> `});
    let slowList='';an.slowest.forEach(w=>{const avg=Math.round(w.totalMs/w.n/1000*10)/10;slowList+=`<span class="bg-red-900/30 text-red-300 text-xs px-2 py-1 rounded-full">${w.w} ${avg}s</span> `});

    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <button onclick="S.sc='levels';render()" class="text-slate-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
    <h2 class="text-xl font-bold text-white mb-4">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

    <!-- Summary cards -->
    <div class="grid grid-cols-3 gap-2 mb-4">
      <div class="bg-slate-800 rounded-xl p-3 text-center"><div class="text-2xl font-bold text-white">${an.todayA}</div><div class="text-slate-500 text-xs">–°–µ–≥–æ–¥–Ω—è</div><div class="text-xs ${an.todayAcc>=70?'text-green-400':'text-amber-400'}">${an.todayAcc}%</div></div>
      <div class="bg-slate-800 rounded-xl p-3 text-center"><div class="text-2xl font-bold text-white">${an.weekA}</div><div class="text-slate-500 text-xs">–ó–∞ –Ω–µ–¥–µ–ª—é</div><div class="text-xs ${an.weekAcc>=70?'text-green-400':'text-amber-400'}">${an.weekAcc}%</div></div>
      <div class="bg-slate-800 rounded-xl p-3 text-center"><div class="text-2xl font-bold text-white">${an.allA}</div><div class="text-slate-500 text-xs">–í—Å–µ–≥–æ</div><div class="text-xs ${an.allAcc>=70?'text-green-400':'text-amber-400'}">${an.allAcc}%</div></div>
    </div>

    <!-- Response time -->
    <div class="bg-slate-800 rounded-xl p-3 mb-4">
      <div class="text-slate-400 text-xs mb-1">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
      <div class="flex items-baseline gap-2"><span class="text-2xl font-bold text-white">${(an.todayAvgMs/1000).toFixed(1)}s</span><span class="text-slate-500 text-xs">—Å–µ–≥–æ–¥–Ω—è</span><span class="text-lg text-slate-400">${(an.avgMs/1000).toFixed(1)}s</span><span class="text-slate-500 text-xs">–≤—Å–µ–≥–æ</span></div>
    </div>

    <!-- Daily chart -->
    <div class="bg-slate-800 rounded-xl p-3 mb-4">
      <div class="text-slate-400 text-xs mb-2">–°–ª–æ–≤ –≤ –¥–µ–Ω—å (14 –¥–Ω–µ–π)</div>
      <div class="flex items-end gap-1 h-24 overflow-hidden">${bars}</div>
    </div>

    <!-- Accuracy by level -->
    <div class="bg-slate-800 rounded-xl p-3 mb-4">
      <div class="text-slate-400 text-xs mb-2">–¢–æ—á–Ω–æ—Å—Ç—å –ø–æ —É—Ä–æ–≤–Ω—è–º</div>
      ${lvlBars||'<div class="text-slate-600 text-xs">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}
    </div>

    <!-- Speed -->
    <div class="bg-slate-800 rounded-xl p-3 mb-4">
      <div class="text-slate-400 text-xs mb-2">‚ö° –ë—ã—Å—Ç—Ä—ã–µ —Å–ª–æ–≤–∞</div>
      <div class="flex flex-wrap gap-1">${speedList||'<span class="text-slate-600 text-xs">–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö</span>'}</div>
      <div class="text-slate-400 text-xs mb-2 mt-3">üêå –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞</div>
      <div class="flex flex-wrap gap-1">${slowList||'<span class="text-slate-600 text-xs">–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö</span>'}</div>
    </div>

    <!-- Hardest words -->
    ${an.hardest.length?`<div class="bg-slate-800 rounded-xl p-3 mb-4">
      <div class="text-slate-400 text-xs mb-2">ü©∏ –¢—Ä—É–¥–Ω—ã–µ —Å–ª–æ–≤–∞</div>
      <div class="max-h-40 overflow-y-auto">${hardList}</div>
    </div>`:''}

    <!-- Confusion pairs -->
    ${an.confused.length?`<div class="bg-red-900/20 border border-red-500/20 rounded-xl p-3 mb-4">
      <div class="text-red-400 text-xs mb-2">üîÄ –ü—É—Ç–∞–Ω–∏—Ü–∞ ‚Äî —á—Ç–æ –æ—Ç–≤–µ—á–∞–ª –≤–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ</div>
      <div class="max-h-48 overflow-y-auto">${confList}</div>
      <button onclick="trainConfused()" class="w-full mt-3 py-2 rounded-xl bg-red-500/20 border border-red-500/50 text-red-400 font-semibold text-sm active:scale-95">üéØ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–ª–æ–≤–∞</button>
    </div>`:''}

    <!-- Recent sessions -->
    ${an.recentSessions.length?`<div class="bg-slate-800 rounded-xl p-3 mb-4">
      <div class="text-slate-400 text-xs mb-2">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏</div>
      <div class="max-h-36 overflow-y-auto">${sessList}</div>
    </div>`:''}

    <div class="text-slate-600 text-xs text-center">–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π: ${an.totalEvents}</div>
    <button onclick="if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É?')){save(LS_LOG,[]);save(LS_CONF,{});toast('–û—á–∏—â–µ–Ω–æ');render()}" class="w-full mt-3 py-2 rounded-xl bg-slate-800 text-red-400 text-xs">üóë –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</button>
    </div></div>`;return}

  // ADD
  if(S.sc==='add'){
    const lo=[1,2,3,4,5].map(l=>`<option value="${l}">${l} ${LN[l]}</option>`).join('');
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <button onclick="S.sc='levels';render()" class="text-slate-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
    <h2 class="text-xl font-bold text-white mb-4">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞</h2>
    <div class="flex gap-1 mb-4"><button onclick="showTab('s')" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white text-xs font-semibold" id="tab-s">‚úèÔ∏è –û–¥–Ω–æ</button><button onclick="showTab('b')" class="flex-1 py-2 rounded-lg bg-slate-800 text-slate-400 text-xs" id="tab-b">üìã –°–ø–∏—Å–æ–∫</button><button onclick="showTab('p')" class="flex-1 py-2 rounded-lg bg-slate-800 text-slate-400 text-xs" id="tab-p">üìù –¢–µ–∫—Å—Ç</button></div>
    <div id="panel-s"><div class="space-y-3"><input id="aw-w" placeholder="Word"><input id="aw-t" placeholder="–ü–µ—Ä–µ–≤–æ–¥"><input id="aw-e" placeholder="Example (optional)"><input id="aw-h" placeholder="Hint (optional)"><select id="aw-l">${lo}</select><button onclick="addSingle()" class="w-full py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-semibold active:scale-95">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>
    <div id="panel-b" style="display:none"><div class="space-y-3"><div class="text-slate-400 text-xs">–§–æ—Ä–º–∞—Ç: <code class="bg-slate-700 px-1 rounded">word - –ø–µ—Ä–µ–≤–æ–¥</code></div><textarea id="imp-txt" rows="6" placeholder="apple - —è–±–ª–æ–∫–æ&#10;banana - –±–∞–Ω–∞–Ω"></textarea><select id="imp-l">${lo}</select><button onclick="importBulk()" class="w-full py-3 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold active:scale-95">–ò–º–ø–æ—Ä—Ç</button></div></div>
    <div id="panel-p" style="display:none"><div class="space-y-3"><div class="text-slate-400 text-xs">–í—Å—Ç–∞–≤—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç ‚Äî —Å–ª–æ–≤–∞ –±—É–¥—É—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div><textarea id="pt-txt" rows="5" placeholder="Paste English text here..."></textarea><select id="pt-l">${lo}</select><button id="pt-btn" onclick="parseText()" class="w-full py-3 rounded-xl bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold active:scale-95">üîç –ò–∑–≤–ª–µ—á—å</button><div id="pt-res"></div></div></div>
    <div class="mt-6 pt-4 border-t border-slate-700 flex gap-3"><button onclick="exportData()" class="flex-1 py-3 rounded-xl bg-slate-800 text-white font-semibold text-sm active:scale-95">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button><button onclick="importData()" class="flex-1 py-3 rounded-xl bg-slate-800 text-white font-semibold text-sm active:scale-95">üì• –ò–º–ø–æ—Ä—Ç</button></div>
    <div class="mt-4 pt-4 border-t border-slate-700">
      <h3 class="text-white font-semibold text-sm mb-2">ü§ñ AI –¢—å—é—Ç–æ—Ä (Claude API)</h3>
      <div class="text-slate-400 text-xs mb-2">–ü–æ–ª—É—á–∏ –∫–ª—é—á –Ω–∞ <a href="https://console.anthropic.com" target="_blank" class="text-blue-400 underline">console.anthropic.com</a></div>
      <input id="cfg-ai-key" type="password" placeholder="sk-ant-..." class="mb-2 text-sm" value="${getAIConfig().key}">
      <input id="cfg-ai-model" placeholder="Model" class="mb-2 text-sm" value="${getAIConfig().model}">
      <button onclick="const c=getAIConfig();c.key=document.getElementById('cfg-ai-key').value.trim();c.model=document.getElementById('cfg-ai-model').value.trim()||'claude-sonnet-4-20250514';saveAIConfig(c);toast('AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!')" class="w-full py-2 rounded-xl bg-purple-600 text-white font-semibold text-sm active:scale-95">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
    <div class="mt-4 pt-4 border-t border-slate-700">
      <button onclick="save('vm2_onboarded',false);S.sc='onboard_intro';render()" class="w-full py-2 rounded-xl bg-slate-800 text-slate-400 text-sm active:scale-95">üéØ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç —É—Ä–æ–≤–Ω—è –∑–∞–Ω–æ–≤–æ</button>
    </div>
    </div></div>`;return}

  // MODE SELECT
  if(S.sM!==null){const l=S.sM,s=gS(l),c=LC[l],dc=getDueCount(l),nt=getNewToday(l);
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <button onclick="S.sM=null;render()" class="text-slate-400 text-sm mb-4">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="text-center mb-6"><div class="w-16 h-16 rounded-full bg-gradient-to-br ${c.bg} mx-auto mb-3 flex items-center justify-center text-2xl font-bold text-white shadow-lg">${l}</div><h2 class="text-xl font-bold text-white">–£—Ä–æ–≤–µ–Ω—å ${l} ‚Äî ${LN[l]}</h2><p class="text-slate-400 text-sm mt-1">${s.t} —Å–ª–æ–≤</p></div>
    <div class="grid grid-cols-3 gap-2 mb-4 text-center"><div class="bg-slate-800 rounded-xl p-2"><div class="text-green-400 font-bold">${s.m}</div><div class="text-slate-500 text-xs">–û—Å–≤–æ–µ–Ω–æ</div></div><div class="bg-slate-800 rounded-xl p-2"><div class="text-amber-400 font-bold">${dc.due}</div><div class="text-slate-500 text-xs">–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</div></div><div class="bg-slate-800 rounded-xl p-2"><div class="text-blue-400 font-bold">${s.nw}</div><div class="text-slate-500 text-xs">–ù–æ–≤—ã—Ö</div></div></div>
    <div class="space-y-3">
    ${dc.due>0?`<button onclick="go(${l},'due')" class="w-full bg-amber-900/30 hover:bg-amber-900/50 border border-amber-500/30 rounded-xl p-4 text-left"><div class="text-amber-400 font-semibold">üîÑ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ (${dc.due})</div><div class="text-slate-400 text-xs">–°–ª–æ–≤–∞ –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ä–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å</div></button>`:''}
    <button onclick="go(${l})" class="w-full bg-slate-800 hover:bg-slate-700 rounded-xl p-4 text-left"><div class="text-white font-semibold">üìö –°–º–µ—à–∞–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è</div><div class="text-slate-400 text-xs">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ + –¥–æ ${NEW_PER_DAY} –Ω–æ–≤—ã—Ö/–¥–µ–Ω—å</div></button>
    ${s.nw>0?`<button onclick="go(${l},'new')" class="w-full bg-slate-800 hover:bg-slate-700 rounded-xl p-4 text-left"><div class="text-blue-400 font-semibold">üÜï –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ (${Math.min(s.nw,Math.max(0,NEW_PER_DAY-nt.introduced))})</div><div class="text-slate-400 text-xs">–°–µ–≥–æ–¥–Ω—è –∏–∑—É—á–µ–Ω–æ: ${nt.introduced}/${NEW_PER_DAY}</div></button>`:''}
    <button onclick="startAudioMode(${l},'due')" class="w-full bg-indigo-900/30 hover:bg-indigo-900/50 border border-indigo-500/20 rounded-xl p-4 text-left"><div class="text-indigo-400 font-semibold">üéß –ê—É–¥–∏–æ-—Ä–µ–∂–∏–º</div><div class="text-slate-400 text-xs">–°–ª—É—à–∞–π —Å–ª–æ–≤–∞ –Ω–∞ —Ö–æ–¥—É</div></button>
    </div></div></div>`;return}

  // LEVELS
  if(S.sc==='levels'){
    const tW=Object.values(db).reduce((s,l)=>s+l.length,0);const tM=Object.entries(db).reduce((s,[l,w])=>s+w.filter((_,i)=>{const c=getCard(+l,i);return c.st===2&&c.reps>=3}).length,0);
    let lvls='';for(let l=1;l<=5;l++){const u=uL.includes(l),pr=gP(l),s=gS(l),c=LC[l],dc=getDueCount(l);
      lvls+=`<button onclick="${u?`S.sM=${l};render()`:''}" ${u?'':'disabled'} class="w-full rounded-xl p-4 text-left transition-all ${u?'bg-slate-800 hover:bg-slate-700':'bg-slate-900 opacity-50 cursor-not-allowed'}" ${u?'':'style="filter:grayscale(100%)"'}>
      <div class="flex items-center gap-3"><div class="w-12 h-12 rounded-full bg-gradient-to-br ${c.bg} flex items-center justify-center font-bold text-white text-lg shadow-lg shrink-0">${u?l:'üîí'}</div>
      <div class="flex-1"><div class="flex items-center justify-between"><div><span class="text-white font-semibold">–£—Ä.${l}</span> <span class="text-slate-400 text-sm">${LN[l]}</span></div><span class="text-slate-400 text-sm">${s.m}/${s.t}</span></div>
      <div class="mt-2 h-2 bg-slate-700 rounded-full overflow-hidden"><div class="h-full ${c.b} rounded-full" style="width:${pr*100}%"></div></div>
      <div class="flex gap-3 mt-1 text-xs">${dc.due>0?`<span class="text-amber-400">üîÑ${dc.due}</span>`:''}${s.nw>0&&u?`<span class="text-blue-400">üÜï${s.nw}</span>`:''}${!u&&l>1?`<span class="text-slate-500">–û—Å–≤–æ–π 70% —É—Ä.${l-1}</span>`:''}${pr>=1?`<span class="text-green-400">‚úÖ</span>`:''}</div>
      </div></div></button>`}

    // Heatmap (last 28 days)
    const days=streak.days||{};let hm='';for(let i=27;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().slice(0,10);const v=days[ds]||0;
      const bg=v===0?'bg-slate-800':v<5?'bg-green-900':v<15?'bg-green-700':v<30?'bg-green-500':'bg-green-400';
      hm+=`<div class="w-3 h-3 rounded-sm ${bg}" title="${ds}: ${v}"></div>`}

    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <div class="text-center mb-4 relative"><h1 class="text-3xl font-bold text-white mb-1">üìö VocabMaster</h1><p class="text-slate-400 text-sm">${tW} —Å–ª–æ–≤ ‚Äî FSRS</p>
    <div class="absolute top-0 right-0 flex gap-2"><button onclick="toggleSound()" class="text-xl opacity-70 hover:opacity-100">${soundOn?'üîä':'üîá'}</button><button onclick="tutorWord=null;tutorChat=[];S.sc='tutor';render()" class="text-xl opacity-70 hover:opacity-100">ü§ñ</button><button onclick="S.sc='read';render()" class="text-xl opacity-70 hover:opacity-100">üìñ</button><button onclick="S.sc='analytics';render()" class="text-xl opacity-70 hover:opacity-100">üìä</button><button onclick="S.sc='add';render()" class="text-xl opacity-70 hover:opacity-100">‚öôÔ∏è</button></div></div>

    ${totalDue>0?`<button onclick="goDaily()" class="w-full mb-3 py-4 rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold text-lg shadow-lg active:scale-95 hover:shadow-xl transition-all">üìÖ –ü–æ–≤—Ç–æ—Ä–∏ —Å–µ–≥–æ–¥–Ω—è (${totalDue})</button>`:`<div class="w-full mb-3 py-3 rounded-xl bg-slate-800 text-center text-green-400 font-semibold">‚úÖ –í—Å–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–¥–µ–ª–∞–Ω—ã!</div>`}

    ${(()=>{const wod=getWordOfDay();if(!wod)return'';const rel=getRelated(wod.w);
    return`<div class="bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border border-indigo-500/20 rounded-xl p-3 mb-3">
      <div class="flex items-center justify-between mb-1"><span class="text-indigo-400 text-xs font-semibold">‚≠ê –°–ª–æ–≤–æ –¥–Ω—è</span><span class="text-slate-500 text-xs">${LN[wod.lv]}</span></div>
      <div class="flex items-center gap-2"><span class="text-white font-bold text-lg">${wod.w}</span><button onclick="doSpeak('${wod.w}')" class="text-blue-400">üîä</button><span class="text-cyan-300 text-sm">‚Äî ${wod.tr}</span></div>
      <div class="text-slate-400 text-xs italic mt-1">${wod.ex}</div>
      ${rel.synonyms.length?`<div class="text-xs mt-1"><span class="text-green-400">= </span><span class="text-slate-500">${rel.synonyms.slice(0,3).join(', ')}</span></div>`:''}
    </div>`})()}

    <div class="bg-slate-800 rounded-xl p-4 mb-4">
    <div class="grid grid-cols-4 gap-2 text-center"><div><div class="text-xl font-bold text-white">${tM}</div><div class="text-xs text-slate-400">–û—Å–≤–æ–µ–Ω–æ</div></div><div><div class="text-xl font-bold text-white">${tW-tM}</div><div class="text-xs text-slate-400">–û—Å—Ç–∞–ª–æ—Å—å</div></div><div><div class="text-xl font-bold text-amber-400">üî•${streak.current||0}</div><div class="text-xs text-slate-400">–î–Ω–µ–π</div></div><div><div class="text-xl font-bold text-white">${streak.best||0}</div><div class="text-xs text-slate-400">–†–µ–∫–æ—Ä–¥</div></div></div>
    <div class="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-green-400 via-yellow-400 to-red-400 rounded-full" style="width:${tW?((tM/tW)*100):0}%"></div></div>
    <div class="flex justify-between text-xs text-slate-500 mt-2"><span>${Math.round(tW?((tM/tW)*100):0)}%</span><span>${(days[today()]||0)} —Å–ª–æ–≤ —Å–µ–≥–æ–¥–Ω—è</span></div>
    <div class="flex flex-wrap gap-1 mt-3 justify-center">${hm}</div></div>

    <div class="space-y-3">${lvls}</div>
    <button onclick="S.sc='add';render()" class="w-full mt-4 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 font-semibold text-sm">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞ | üì§üì• –ë—ç–∫–∞–ø</button>
    <div class="grid grid-cols-2 gap-2 mt-2">
      <button onclick="S.sc='read';render()" class="py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 font-semibold text-sm">üìñ –ß—Ç–µ–Ω–∏–µ</button>
      <button onclick="S.sc='topics';render()" class="py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 font-semibold text-sm">üè∑ –¢–µ–º—ã</button>
      <button onclick="S.sc='games';render()" class="py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 font-semibold text-sm">üéÆ –ú–∏–Ω–∏-–∏–≥—Ä—ã</button>
      <button onclick="S.sc='badges';render()" class="py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 font-semibold text-sm">üèÜ ${getUnlockedBadges().length}/${BADGES.length}</button>
    </div>
    <button onclick="startAudioAll()" class="w-full mt-2 py-3 rounded-xl bg-gradient-to-r from-indigo-900/60 to-purple-900/60 border border-indigo-500/30 hover:border-indigo-500/50 text-indigo-300 font-semibold text-sm">üéß –ê—É–¥–∏–æ-—Ä–µ–∂–∏–º (—É—á–∏ –Ω–∞ —Ö–æ–¥—É)</button>
    </div></div>`;return}

  // STUDY
  if(S.sc==='study'){const cW=S.sQ[S.cI];if(!cW){S.sc='results';render();return}
    const c=getCard(cW.lv,cW.i);const cl=LC[cW.lv]||LC[1];const pct=((S.cI+1)/S.sQ.length)*100;
    const leech=c.leech?`<div class="text-xs text-red-400 mb-2">ü©∏ –¢—Ä—É–¥–Ω–æ–µ —Å–ª–æ–≤–æ ‚Äî <button onclick="openTutor('${cW.w}','${cW.tr.replace(/'/g,"\\'")}','${safeEx}',${cW.lv})" class="text-purple-400 underline">—Å–ø—Ä–æ—Å–∏ AI ü§ñ</button></div>`:'';
    const safeEx=cW.ex.replace(/'/g,"\\'");let ci='';

    if(cW.mode===0){ci=`${leech}<div class="text-4xl font-bold text-white mb-1">${cW.w}</div><div class="flex justify-center gap-3 mb-1"><button onclick="doSpeak('${cW.w}')" class="text-blue-400 text-2xl active:scale-90">üîä</button><button onclick="openTutor('${cW.w}','${cW.tr.replace(/'/g,"\\'")}','${safeEx}',${cW.lv})" class="text-purple-400 text-2xl active:scale-90">ü§ñ</button></div><div class="text-slate-400 text-sm italic mb-4">${cW.ex} <button onclick="doSpeak('${safeEx}')" class="text-blue-400 text-xs">üîà</button></div>
    ${!S.sA&&!S.sH?'<button onclick="S.sH=true;render()" class="text-amber-400 text-xs mb-4 hover:underline block mx-auto">üí°</button>':''}${S.sH&&!S.sA?`<div class="bg-amber-900/30 rounded-lg px-3 py-2 mb-4"><span class="text-amber-300 text-sm">üí° ${cW.h}</span></div>`:''}
    ${!S.sA?`<button onclick="S.sA=true;render()" class="w-full py-3 rounded-xl bg-gradient-to-r ${cl.bg} text-white font-semibold text-lg shadow-lg active:scale-95">–ü–æ–∫–∞–∑–∞—Ç—å</button>`:
          `<div class="text-3xl font-bold text-cyan-300 mb-4 mt-2">${cW.tr}</div>${renderRelated(cW.w)}<div class="flex gap-2"><button onclick="ans(1)" class="flex-1 py-3 rounded-xl bg-red-500/20 border border-red-500/50 text-red-400 font-semibold active:scale-95">–°–Ω–æ–≤–∞</button><button onclick="ans(3)" class="flex-1 py-3 rounded-xl bg-green-500/20 border border-green-500/50 text-green-400 font-semibold active:scale-95">–ó–Ω–∞—é</button><button onclick="ans(4)" class="flex-1 py-3 rounded-xl bg-blue-500/20 border border-blue-500/50 text-blue-400 font-semibold active:scale-95">–õ–µ–≥–∫–æ</button></div>`}`}
    else if(cW.mode===1){ci=`${leech}<div class="text-sm text-amber-400 mb-2">üîÑ –ö–∞–∫ –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏?</div><div class="text-4xl font-bold text-cyan-300 mb-2">${cW.tr}</div><button onclick="openTutor('${cW.w}','${cW.tr.replace(/'/g,"\\'")}','${safeEx}',${cW.lv})" class="text-purple-400 text-lg active:scale-90 mb-2 block mx-auto">ü§ñ –ø–æ–º–æ—â—å</button>
    ${!S.sA?`<button onclick="S.sA=true;render()" class="w-full py-3 rounded-xl bg-gradient-to-r ${cl.bg} text-white font-semibold text-lg shadow-lg active:scale-95">–ü–æ–∫–∞–∑–∞—Ç—å</button>`:
    `<div class="text-3xl font-bold text-white mb-2">${cW.w}</div><button onclick="doSpeak('${cW.w}')" class="text-blue-400 text-2xl mb-3 active:scale-90">üîä</button>${renderRelated(cW.w)}<div class="flex gap-2"><button onclick="ans(1)" class="flex-1 py-3 rounded-xl bg-red-500/20 border border-red-500/50 text-red-400 font-semibold active:scale-95">–°–Ω–æ–≤–∞</button><button onclick="ans(3)" class="flex-1 py-3 rounded-xl bg-green-500/20 border border-green-500/50 text-green-400 font-semibold active:scale-95">–ó–Ω–∞—é</button><button onclick="ans(4)" class="flex-1 py-3 rounded-xl bg-blue-500/20 border border-blue-500/50 text-blue-400 font-semibold active:scale-95">–õ–µ–≥–∫–æ</button></div>`}`}
    else if(cW.mode===2){if(!S.cOpts.length)S.cOpts=getRandChoices(cW);
      ci=`${leech}<div class="text-sm text-purple-400 mb-2">üéØ –í—ã–±–µ—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥</div><div class="text-4xl font-bold text-white mb-1">${cW.w}</div><button onclick="doSpeak('${cW.w}')" class="text-blue-400 text-2xl mb-3 active:scale-90">üîä</button>
      <div class="space-y-2">${S.cOpts.map(o=>{let cls='bg-slate-700 hover:bg-slate-600 text-white';if(S.cAns!==null){if(o===cW.tr)cls='bg-green-600 text-white';else if(o===S.cAns)cls='bg-red-600 text-white';else cls='bg-slate-700 text-slate-500'}
      return`<button onclick="${S.cAns===null?`checkChoice('${o.replace(/'/g,"\\'")}')`:''}" class="w-full py-3 rounded-xl ${cls} font-medium text-left px-4">${o}</button>`}).join('')}</div>`}
    else{const ok=S.sA&&S.typed.toLowerCase().trim()===cW.w.toLowerCase().trim();
      ci=`${leech}<div class="text-sm text-green-400 mb-2">‚å®Ô∏è –ù–∞–ø–∏—à–∏ —Å–ª–æ–≤–æ</div><div class="text-3xl font-bold text-cyan-300 mb-2">${cW.tr}</div><div class="text-slate-400 text-sm mb-4">${cW.h}</div>
      ${!S.sA?`<input id="ti" type="text" placeholder="English word..." class="text-center text-lg mb-3" autocomplete="off" autocapitalize="none" spellcheck="false" onkeydown="if(event.key==='Enter')checkTyped()"><button onclick="checkTyped()" class="w-full py-3 rounded-xl bg-gradient-to-r ${cl.bg} text-white font-semibold active:scale-95">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>`:
      `<div class="p-3 rounded-xl mb-3 ${ok?'bg-green-900/40 border border-green-500/50':'bg-red-900/40 border border-red-500/50'}"><div class="text-sm ${ok?'text-green-400':'text-red-400'}">${ok?'–í–µ—Ä–Ω–æ!':'–ù–µ–≤–µ—Ä–Ω–æ'}</div>${!ok?`<div class="text-slate-400 text-xs mt-1">–û—Ç–≤–µ—Ç: <span class="text-red-300">${S.typed}</span></div>`:''}<div class="text-white font-bold text-xl mt-1">${cW.w}</div><button onclick="doSpeak('${cW.w}')" class="text-blue-400 text-xl mt-1 active:scale-90">üîä</button></div>${renderRelated(cW.w)}`}`}

    // MODE 4: Active Recall ‚Äî write a sentence
    if(cW.mode===4){
      const sr=S.sentenceResult;
      ci=`${leech}<div class="text-sm text-orange-400 mb-2">‚úçÔ∏è –°–æ—Å—Ç–∞–≤—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</div>
      <div class="text-2xl font-bold text-white mb-1">${cW.w} <button onclick="doSpeak('${cW.w}')" class="text-blue-400 text-lg">üîä</button></div>
      <div class="text-cyan-300 mb-3">${cW.tr}</div>
      ${!S.sA?`<textarea id="si" rows="2" placeholder="Write a sentence using '${cW.w}'..." class="text-sm mb-3" autocapitalize="sentences"></textarea>
      <button id="s-check-btn" onclick="checkSentence()" class="w-full py-3 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 text-white font-semibold active:scale-95">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>`:
      `<div class="p-3 rounded-xl mb-3 ${sr&&sr.ok?'bg-green-900/40 border border-green-500/50':'bg-red-900/40 border border-red-500/50'}">
        <div class="text-white text-sm italic mb-2">"${S.typed}"</div>
        ${sr?`<div class="text-sm ${sr.ok?'text-green-400':'text-red-400'} mb-1">${sr.ok?'–û—Ç–ª–∏—á–Ω–æ!':'–ù—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å'} ${sr.score?'‚≠ê'.repeat(sr.score):''}</div>
        ${sr.grammar&&sr.grammar!=='ok'?`<div class="text-xs text-amber-300 mb-1">üìù ${sr.grammar}</div>`:''}
        ${sr.usage&&sr.usage!=='ok'?`<div class="text-xs text-blue-300 mb-1">üí° ${sr.usage}</div>`:''}
        ${sr.better?`<div class="text-xs text-green-300 mt-1">‚ú® ${sr.better}</div>`:''}`
        :`<div class="text-slate-400 text-sm">${sr?.feedback||''}</div>`}
      </div>${renderRelated(cW.w)}`}`;
    }

    a.innerHTML=`<div id="sw" style="${BG}" class="p-4"><div class="max-w-md mx-auto">
    <div class="flex items-center justify-between mb-4"><button onclick="S.sc='levels';render()" class="text-slate-400 text-sm">‚Üê</button><div class="text-sm font-semibold ${cl.t}">${S.cL?'–£—Ä.'+S.cL:'–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ'}</div><div class="flex items-center gap-3"><button onclick="toggleSound()" class="text-lg opacity-70 hover:opacity-100">${soundOn?'üîä':'üîá'}</button><span class="text-slate-400 text-sm">${S.cI+1}/${S.sQ.length}</span></div></div>
    <div class="h-1.5 bg-slate-700 rounded-full mb-5 overflow-hidden"><div class="h-full ${cl.b} rounded-full" style="width:${pct}%"></div></div>
    <div id="card" class="rounded-2xl p-6 text-center bg-slate-800">${ci}</div></div></div>`;
    if(cW.mode<=1){const w=document.getElementById('sw');w.ontouchstart=e=>{touchX=e.touches[0].clientX};w.ontouchend=e=>{if(!S.sA)return;const d=e.changedTouches[0].clientX-touchX;if(d>80)ans(3);else if(d<-80)ans(1)}}
    if(cW.mode===3&&!S.sA)setTimeout(()=>{const i=document.getElementById('ti');if(i)i.focus()},100);
    if(cW.mode===4&&!S.sA)setTimeout(()=>{const i=document.getElementById('si');if(i)i.focus()},100);
    if((cW.mode===0||cW.mode===2)&&!S.sA)speak(cW.w);
    cardShownAt=Date.now();
    return}

  // RESULTS
  if(S.sc==='results'){checkNewBadges();const ok=S.sR.filter(r=>r.ok).length,tot=S.sR.length,pct=tot?Math.round((ok/tot)*100):0;const cl=LC[S.cL]||LC[1];const lp=S.cL?gP(S.cL):0;const s=S.cL?gS(S.cL):null;
    const failed=S.sR.filter(r=>!r.ok);
    const items=S.sR.map(r=>`<div class="flex items-center justify-between py-1 border-b border-slate-700/50 last:border-0"><span class="text-white text-sm">${r.w}</span><div class="flex items-center gap-2">${!r.ok?`<button onclick="openTutor('${r.w}','${r.tr.replace(/'/g,"\\'")}','${(r.ex||'').replace(/'/g,"\\'")}',${r.lv})" class="text-purple-400 text-xs">ü§ñ</button>`:''}<span class="text-slate-400 text-xs">${r.tr}</span><span>${r.ok?'‚úÖ':'‚ùå'}</span></div></div>`).join('');
    // Session confused words
    const conf=load(LS_CONF,{});
    let confHtml='';failed.forEach(f=>{const cd=conf[f.w.toLowerCase()];if(cd&&cd.wrong.length){confHtml+=`<div class="flex items-center justify-between py-1"><span class="text-white text-sm">${f.w}</span><div class="flex gap-1">${cd.wrong.slice(0,2).map(w=>`<span class="bg-red-900/30 text-red-300 text-xs px-2 py-0.5 rounded-full">${w.v}</span>`).join('')}</div></div>`}});
    a.innerHTML=`<div style="${BG}" class="p-4"><div class="max-w-md mx-auto text-center">
    <div class="text-5xl mb-4">${pct>=80?'üéâ':pct>=50?'üëç':'üí™'}</div><h2 class="text-2xl font-bold text-white mb-1">–ì–æ—Ç–æ–≤–æ!</h2>
    <div class="bg-slate-800 rounded-2xl p-6 mt-5"><div class="text-5xl font-bold text-white mb-1">${pct}%</div><div class="text-slate-400 text-sm">${ok}/${tot}</div>
    <div class="grid grid-cols-2 gap-4 mt-4"><div class="bg-slate-700/50 rounded-xl p-3"><div class="text-green-400 text-xl font-bold">${ok}</div><div class="text-slate-400 text-xs">–í–µ—Ä–Ω–æ</div></div><div class="bg-slate-700/50 rounded-xl p-3"><div class="text-red-400 text-xl font-bold">${tot-ok}</div><div class="text-slate-400 text-xs">–û—à–∏–±–∫–∏</div></div></div>
    ${s?`<div class="mt-4"><div class="flex justify-between text-sm text-slate-400 mb-1"><span>–£—Ä.${S.cL}</span><span>${s.m}/${s.t}</span></div><div class="h-3 bg-slate-700 rounded-full overflow-hidden"><div class="h-full ${cl.b} rounded-full" style="width:${lp*100}%"></div></div></div>`:''}</div>
    ${confHtml?`<div class="mt-4 bg-red-900/20 border border-red-500/20 rounded-xl p-3 text-left"><div class="text-red-400 text-xs mb-2">üîÄ –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏</div>${confHtml}</div>`:''}
    <div class="mt-4 bg-slate-800 rounded-xl p-4 max-h-48 overflow-y-auto text-left">${items}</div>
    <div class="flex gap-3 mt-5">${S.cL?`<button onclick="go(${S.cL})" class="flex-1 py-3 rounded-xl bg-gradient-to-r ${cl.bg} text-white font-semibold shadow-lg active:scale-95">üîÑ</button>`:''}<button onclick="S.sc='analytics';render()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-semibold active:scale-95">üìä</button><button onclick="S.sc='levels';render()" class="flex-1 py-3 rounded-xl bg-slate-700 text-white font-semibold active:scale-95">üè†</button></div>
    </div></div>`}
}

// === AI TUTOR ===
const LS_AI='vm2_ai';
function getAIConfig(){return load(LS_AI,{key:'',endpoint:'https://api.anthropic.com/v1/messages',model:'claude-sonnet-4-20250514'})}
function saveAIConfig(c){save(LS_AI,c)}

async function askAI(prompt,context){
  const cfg=getAIConfig();
  if(!cfg.key){toast('–î–æ–±–∞–≤—å API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ‚öôÔ∏è','#ef4444');return null}
  const sysPrompt='You are a friendly English language tutor helping a Russian speaker learn English vocabulary. Be concise. Use both English and Russian in explanations. Format with markdown-like structure but keep it short (under 200 words). Focus on practical usage.';
  try{
    const r=await fetch(cfg.endpoint,{method:'POST',headers:{'Content-Type':'application/json','x-api-key':cfg.key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:cfg.model,max_tokens:500,system:sysPrompt,messages:[{role:'user',content:(context?context+'\n\n':'')+prompt}]})});
    if(!r.ok){const e=await r.text();throw new Error(e)}
    const d=await r.json();return d.content[0].text;
  }catch(e){console.error(e);toast('AI –æ—à–∏–±–∫–∞: –ø—Ä–æ–≤–µ—Ä—å –∫–ª—é—á','#ef4444');return null}
}

// Pre-built prompts for word context
function tutorPrompts(word,tr){return{
  explain:`Explain the English word "${word}" (${tr}) to a Russian speaker. Include: 1) Clear definition 2) Common collocations 3) Register (formal/informal) 4) One memorable example sentence.`,
  mnemonic:`Create a memorable mnemonic or association to help a Russian speaker remember that "${word}" means "${tr}". Use sound similarities between English and Russian, visual associations, or a funny mini-story. Be creative!`,
  examples:`Give 5 diverse example sentences using "${word}" in different contexts (business, daily life, academic, casual, literature). Mark difficulty: [easy] [medium] [hard]. Add Russian translation for each.`,
  difference:`What are common words that are easily confused with "${word}"? Explain the differences clearly with examples. If "${word}" has synonyms, explain the nuance between them. Use Russian translations.`,
  usage:`When and how to use "${word}" in real conversations? Give: 1) Situations where this word fits perfectly 2) Common mistakes Russian speakers make with this word 3) A mini-dialogue example using it naturally.`,
}}

let tutorChat=[];let tutorWord=null;

function openTutor(word,tr,ex,lv){
  tutorWord={w:word,tr:tr,ex:ex,lv:lv};tutorChat=[];S.sc='tutor';render();
}

function tutorAsk(type){
  if(!tutorWord)return;
  const prompts=tutorPrompts(tutorWord.w,tutorWord.tr);
  const prompt=prompts[type]||type;
  runTutorQuery(prompt);
}

function tutorCustom(){
  const inp=document.getElementById('tutor-input');if(!inp)return;
  const q=inp.value.trim();if(!q)return;
  inp.value='';
  const context=tutorWord?`Context: the word is "${tutorWord.w}" (${tutorWord.tr}), level ${tutorWord.lv}.`:'';
  runTutorQuery(q,context);
}

async function runTutorQuery(prompt,extraContext){
  const context=tutorWord?`Word: "${tutorWord.w}" = "${tutorWord.tr}". Example: "${tutorWord.ex}".`:'';
  tutorChat.push({role:'user',text:prompt.length>80?prompt.slice(0,80)+'...':prompt});
  render();
  // Show loading
  tutorChat.push({role:'ai',text:'‚è≥ –î—É–º–∞—é...',loading:true});
  render();
  const confData=load(LS_CONF,{});const confInfo=confData[tutorWord?.w?.toLowerCase()];
  let confContext='';if(confInfo&&confInfo.wrong.length){confContext=`\nNote: the student often confuses this word with: ${confInfo.wrong.map(w=>w.v).join(', ')}.`}
  const fullContext=(extraContext||context)+confContext;
  const result=await askAI(prompt,fullContext);
  // Remove loading
  tutorChat=tutorChat.filter(m=>!m.loading);
  if(result){tutorChat.push({role:'ai',text:result})}
  else{tutorChat.push({role:'ai',text:'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.'})}
  logEvent('tutor',{w:tutorWord?.w,prompt:prompt.slice(0,50)});
  render();
}

function formatAIText(text){
  return text
    .replace(/\*\*(.+?)\*\*/g,'<strong class="text-white">$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code class="bg-slate-700 px-1 rounded text-cyan-300">$1</code>')
    .replace(/^(\d+[\.\)]) /gm,'<span class="text-indigo-400">$1</span> ')
    .replace(/^- /gm,'<span class="text-indigo-400">‚Ä¢</span> ')
    .replace(/\[easy\]/gi,'<span class="bg-green-900/40 text-green-300 text-xs px-1 rounded">easy</span>')
    .replace(/\[medium\]/gi,'<span class="bg-yellow-900/40 text-yellow-300 text-xs px-1 rounded">medium</span>')
    .replace(/\[hard\]/gi,'<span class="bg-red-900/40 text-red-300 text-xs px-1 rounded">hard</span>')
    .replace(/\n/g,'<br>');
}

// === KNOWLEDGE GRAPH ===
// Word relationships: roots, families, synonyms, antonyms
const ROOTS={
'port':['transport','export','import','report','support','deport','portable'],
'duct':['conduct','produce','reduce','introduce','deduce','educate'],
'ject':['reject','inject','project','subject','object','eject'],
'scrib':['describe','prescribe','subscribe','inscribe','manuscript'],
'spect':['inspect','respect','suspect','expect','perspective','spectacle'],
'mit':['commit','submit','permit','admit','transmit','emit'],
'vert':['convert','divert','revert','introvert','extrovert','invert'],
'dict':['predict','contradict','verdict','dictate','indicate'],
'cred':['credit','incredible','credentials','credible','creed'],
'gen':['generate','generous','genuine','general','genre','genius'],
'struct':['structure','construct','destroy','instruct','obstruct'],
'tract':['attract','extract','contract','distract','subtract'],
'cept':['accept','concept','except','perceive','reception','intercept'],
'form':['transform','inform','perform','reform','conform','formal'],
'press':['express','impress','compress','depress','suppress'],
'solve':['resolve','dissolve','absolve','solve','solution'],
'pend':['depend','suspend','pending','independent','expenditure'],
'mand':['command','demand','mandate','recommend','reprimand'],
'fic':['sufficient','efficient','significant','magnificent','beneficial'],
'vis':['visible','supervise','revision','vision','invisible','visual'],
};

const PREFIXES={
'un-':['unable','unclear','unfair','unlikely','uncertain','undermine','unprecedented'],
're-':['replace','reduce','recover','reinforce','reconcile','relinquish','repudiate'],
'dis-':['discover','display','disparity','disappear','disorder','dismiss','distinguish'],
'pre-':['prevent','prepare','predict','predominant','preliminary','preclude','prevalent'],
'mis-':['misconception','mistake','misunderstand','mislead','mismatch'],
'over-':['overcome','overseas','overlook','overwhelm','overestimate'],
'in/im-':['improve','impossible','imminent','impeccable','impartial','inevitable'],
'ex-':['explain','expand','expedite','exaggerate','exacerbate','extract','explicit'],
'co/con-':['contribute','consistent','comprehensive','concurrent','corroborate','coherent'],
};

const SYNONYMS={
'big':['large','huge','enormous','vast','immense','gigantic'],
'small':['tiny','little','minor','slight','miniature'],
'good':['excellent','superb','outstanding','remarkable','fine'],
'bad':['terrible','awful','dreadful','poor','inferior'],
'important':['significant','crucial','vital','essential','paramount'],
'difficult':['challenging','demanding','tough','arduous','formidable'],
'beautiful':['gorgeous','stunning','magnificent','exquisite','elegant'],
'happy':['joyful','delighted','cheerful','content','elated','ebullient'],
'sad':['melancholy','sorrowful','gloomy','lugubrious','dejected'],
'fast':['rapid','swift','quick','expedient','prompt'],
'help':['assist','aid','support','facilitate','alleviate'],
'destroy':['demolish','devastate','annihilate','eradicate','obliterate'],
'improve':['enhance','ameliorate','refine','upgrade','bolster'],
'reduce':['diminish','decrease','curtail','mitigate','alleviate'],
'explain':['clarify','elucidate','illustrate','elaborate','expound'],
'change':['transform','modify','alter','convert','revise'],
'stop':['cease','halt','discontinue','terminate','suspend'],
'think':['contemplate','ponder','reflect','consider','speculate'],
'persuade':['convince','coax','cajole','sway','influence'],
};

const ANTONYMS={
'big':'small','good':'bad','happy':'sad','fast':'slow','long':'short','hot':'cold','old':'new','young':'old',
'light':'dark','open':'close','begin':'end','easy':'difficult','beautiful':'ugly','love':'hate',
'increase':'decrease','accept':'reject','success':'failure','strength':'weakness','improve':'deteriorate',
'transparent':'opaque','volatile':'stable','abundant':'scarce','generous':'parsimonious','loquacious':'taciturn',
'bellicose':'peaceful','ebullient':'torpid','diligent':'indolent','magnanimous':'petty','sanguine':'pessimistic',
};

function getRelated(word){
  const w=word.toLowerCase();const result={roots:[],prefix:null,synonyms:[],antonym:null,family:[]};
  // Find root
  for(const[root,words]of Object.entries(ROOTS)){
    if(words.some(x=>x.toLowerCase()===w)||w.includes(root)){
      result.roots.push({root,words:words.filter(x=>x.toLowerCase()!==w)});
    }
  }
  // Find prefix
  for(const[pfx,words]of Object.entries(PREFIXES)){
    if(words.some(x=>x.toLowerCase()===w)){result.prefix={pfx,words:words.filter(x=>x.toLowerCase()!==w).slice(0,5)};}
  }
  // Synonyms
  for(const[key,syns]of Object.entries(SYNONYMS)){
    if(key===w)result.synonyms=syns.slice(0,6);
    else if(syns.includes(w)){result.synonyms=[key,...syns.filter(x=>x!==w)].slice(0,6)}
  }
  // Antonyms
  if(ANTONYMS[w])result.antonym=ANTONYMS[w];
  for(const[k,v]of Object.entries(ANTONYMS)){if(v===w)result.antonym=k}
  return result;
}

function renderRelated(word){
  const r=getRelated(word);if(!r.roots.length&&!r.prefix&&!r.synonyms.length&&!r.antonym)return'';
  let h='<div class="mt-3 pt-3 border-t border-slate-700/50">';
  h+='<div class="text-slate-500 text-xs mb-2">üîó –°–≤—è–∑–∏</div>';
  if(r.roots.length){r.roots.forEach(x=>{h+=`<div class="mb-1"><span class="text-indigo-400 text-xs font-mono">/${x.root}/</span> <span class="text-slate-400 text-xs">${x.words.slice(0,4).join(', ')}</span></div>`})}
  if(r.prefix){h+=`<div class="mb-1"><span class="text-purple-400 text-xs font-mono">${r.prefix.pfx}</span> <span class="text-slate-400 text-xs">${r.prefix.words.join(', ')}</span></div>`}
  if(r.synonyms.length){h+=`<div class="mb-1"><span class="text-green-400 text-xs">= </span><span class="text-slate-400 text-xs">${r.synonyms.join(', ')}</span></div>`}
  if(r.antonym){h+=`<div class="mb-1"><span class="text-red-400 text-xs">‚â† </span><span class="text-slate-400 text-xs">${r.antonym}</span></div>`}
  h+='</div>';return h;
}

// === ACTIVE RECALL (Sentence mode) ===
async function checkSentence(){
  const cW=S.sQ[S.cI];if(!cW)return;
  const inp=document.getElementById('si');if(!inp)return;
  const sentence=inp.value.trim();if(!sentence){toast('–ù–∞–ø–∏—à–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!','#ef4444');return}
  S.typed=sentence;
  const cfg=getAIConfig();
  if(!cfg.key){
    // Fallback: just check if word is present
    const hasWord=sentence.toLowerCase().includes(cW.w.toLowerCase());
    S.sentenceResult={ok:hasWord,feedback:hasWord?'–°–ª–æ–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ. –î–æ–±–∞–≤—å AI –∫–ª—é—á –¥–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.':'–°–ª–æ–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏.'};
    S.sA=true;render();setTimeout(()=>ans(hasWord?3:1),1500);return;
  }
  document.getElementById('s-check-btn').textContent='‚è≥...';document.getElementById('s-check-btn').disabled=true;
  try{
    const r=await fetch(cfg.endpoint,{method:'POST',headers:{'Content-Type':'application/json','x-api-key':cfg.key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:cfg.model,max_tokens:200,system:'You are an English teacher. Evaluate the sentence. Respond in JSON: {"correct":true/false,"score":1-5,"grammar":"ok or error description","usage":"ok or how to improve","better":"improved version or null"}. Be encouraging but honest. Respond ONLY with JSON.',
        messages:[{role:'user',content:`Student used the word "${cW.w}" (meaning: ${cW.tr}) in this sentence: "${sentence}". Evaluate grammar, word usage correctness, and naturalness.`}]})});
    const d=await r.json();const txt=d.content[0].text;
    const json=JSON.parse(txt.replace(/```json\n?/g,'').replace(/```/g,'').trim());
    S.sentenceResult={ok:json.correct&&json.score>=3,...json};
    S.sA=true;render();setTimeout(()=>ans(json.correct&&json.score>=3?3:1),2000);
  }catch(e){
    S.sentenceResult={ok:sentence.toLowerCase().includes(cW.w.toLowerCase()),feedback:'AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–∞–ª–∏—á–∏—é —Å–ª–æ–≤–∞.'};
    S.sA=true;render();setTimeout(()=>ans(S.sentenceResult.ok?3:1),1500);
  }
}

// === CEFR LEVEL ESTIMATOR ===
const CEFR_FREQ={
  'A1':new Set(['be','have','do','say','go','get','make','know','think','come','want','use','find','give','tell','work','call','try','ask','need','feel','become','leave','put','mean','keep','let','begin','seem','help','show','hear','play','run','move','live','believe','bring','happen','write','sit','stand','lose','pay','meet','include','continue','set','learn','change','lead','understand','watch','follow','stop','create','speak','read','allow','add','spend','grow','open','walk','win','offer','remember','love','consider','appear','buy','wait','serve','die','send','expect','build','stay','fall','cut','reach','kill','remain']),
  'A2':new Set(['achieve','accept','according','account','across','act','actually','add','admit','affect','afford','agree','almost','along','amount','another','anyway','apart','appear','apply','area','arrange','arrive','article','attention','available','avoid','aware','based','basic','become','behavior','belong','benefit','beyond','board','border','born','brain','break','breath','bright','burn','calm','capital','career','careful','carry','cause','central','century','chance','character','charge','choice','circle','claim','clear','climb','collect','combine','comfort','comment','common','community','compare','complete','concern','condition','confident','connect','conscious','contact','contain','content','context','control','conversation','copy','corner','correct','count','couple','courage','cover','cross','culture','current','customer','damage','danger','data','deal','death','debate','decision','deep','deliver','demand','department','depend','describe','design','desire','despite','detail','determine','develop','difference','direct','disappear','discover','discuss','disease','distance','divide','document','doubt','draw','dress','drink','drive','drop','earn','edge','education','effective','election','emotion','employ','encourage','energy','engine','enjoy','enormous','enter','environment','equal','escape','especially','establish','even','evening','event','evidence','exactly','examine','example','exchange','excite','exercise','exist','expand','expect','experience','experiment','expert','express','extend','extra','extreme','face','facility','factor','fail','fair','familiar','famous','favor','fear','feature','feed','figure','fill','final','finger','finish','firm','fit','fix','flat','flight','flow','focus','force','foreign','forget','form','former','forward','found','frame','freedom','fresh','front','function','fund','future','gain','gather','general','gentle','glad','global','goal','golden','govern','graduate','grand','grant','gray','green','ground','guard','guess','guide','hang','handle','hardly','hate','head','health','heavy','height','hide','hill','hire','history','hit','hold','hole','holiday','honor','household','huge','human','humor','hunt','hurry','idea','identify','ignore','image','imagine','impact','import','impose','impress','improve','incident','income','indeed','indicate','individual','industry','influence','inform','initial','injury','inner','innocent','input','insert','inside','insist','instead','institution','intend','interest','internal','internet','interpret','introduce','invest','investigate','involve','island','issue','item','join','judge','junior','justice','keen','key','kick','kitchen','knee','knock','knowledge','labor','lack','lady','land','language','largely','launch','layer','league','lean','learn','least','legal','length','lesson','level','library','lift','likely','limit','link','lip','list','literature','load','local','locate','lonely','loose','lord','lovely','lower','luck','lunch','machine','magazine','maintain','major','manage','mark','market','marry','mass','master','match','material','matter','maybe','mayor','meal','meaning','measure','media','medical','memory','mental','mention','merely','message','metal','method','middle','military','mine','minister','minor','minute','mirror','mission','mix','model','modern','modest','moment','mood','moral','motion','mountain','mouse','mount','muscle','mystery','narrow','nation','native','natural','nature','negative','nervous','network','nevertheless','noise','none','normal','northern','note','notice','novel','nowhere','nuclear','numerous','object','observe','obtain','obvious','occasion','occupy','odd','official','online','operate','opinion','oppose','option','order','ordinary','organize','origin','otherwise','outcome','output','outside','overcome','owner','pace','pack','panel','parent','park','partner','passage','passenger','passion','path','pattern','pause','peer','perhaps','permit','personal','phase','philosophy','photograph','phrase','physical','pick','picture','piece','planet','platform','plenty','pocket','poem','poet','policy','politics','pollution','pool','popular','population','portion','positive','possibility','possibly','post','potential','pound','pour','poverty','powerful','practical','predict','prefer','prepare','present','president','press','pressure','previous','price','primary','principle','print','prison','private','prize','probably','proceed','process','product','professor','profit','program','progress','project','promise','promote','proper','property','proportion','proposal','protect','protest','prove','publish','pull','punch','purpose','pursue','push','quarter','question','quiet','quote','race','radio','rain','raise','range','rapid','rare','rather','react','reality','realize','reasonable','recall','recognize','recommend','record','refer','reflect','reform','refuse','regard','region','regular','reject','relate','relationship','relative','release','relevant','relief','religion','rely','remark','remind','remove','repeat','replace','represent','republic','reputation','request','require','research','resident','resist','resource','respond','responsible','rest','restore','restrict','reveal','review','revolution','reward','rich','ring','rise','rough','route','royal','rural','rush','safe','sail','sale','sample','satisfaction','satisfy','scale','scene','schedule','scheme','scope','screen','search','secret','secretary','section','secure','seek','select','senior','sense','sensitive','separate','sequence','series','serious','session','settle','severe','sexual','shake','shape','sharp','sheet','shelter','shift','shout','shut','sight','sign','significant','silence','silly','similar','simple','sink','site','situation','skill','skin','sleep','slip','smart','smell','smooth','snap','soft','soil','soldier','solution','somewhat','sort','soul','southern','speech','speed','spirit','split','sport','spot','spread','spring','square','stable','staff','stage','standard','stare','state','statement','station','status','steal','steam','steel','step','stick','stiff','stock','stomach','storm','strategy','strength','stretch','strike','string','strip','struggle','student','stuff','stupid','style','subject','succeed','suddenly','suffer','suggest','suit','supply','suppose','surface','surprise','surround','survey','survive','suspect','sweet','swing','switch','sympathy','system','target','task','tax','technique','technology','temperature','tend','terrible','test','thank','theater','theme','theory','thick','thin','threaten','throat','throughout','throw','thus','tight','tiny','title','tone','tongue','tool','topic','totally','tough','tour','tower','track','trade','tradition','traffic','train','transfer','travel','treasure','treat','trend','trial','trick','trip','troop','trust','truth','tube','turn','twice','typical','ugly','unable','union','unique','unit','universal','university','unless','unlikely','unusual','upper','upset','urban','used','useful','usual','valley','value','vast','vehicle','version','victim','victory','village','violence','virtually','visible','vital','voice','volume','volunteer','vote','wage','waste','wave','weakness','wealth','weapon','weather','website','weekend','weigh','weird','welcome','western','wheel','whenever','whereas','widely','wild','willing','wing','wire','wise','withdraw','witness','wonder','wooden','worried','worth','wrap','yesterday','youth','zone']),
};
function estimateCEFR(text){
  const words=text.toLowerCase().replace(/[^a-z\s]/g,' ').split(/\s+/).filter(w=>w.length>=3);
  const unique=new Set(words);
  let a1=0,a2=0,other=0;
  unique.forEach(w=>{if(CEFR_FREQ.A1.has(w))a1++;else if(CEFR_FREQ.A2.has(w))a2++;else other++});
  const total=unique.size||1;
  const advancedPct=other/total;
  if(advancedPct>0.5)return{level:'C1-C2',desc:'–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π',color:'text-red-400'};
  if(advancedPct>0.35)return{level:'B2',desc:'–í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ',color:'text-purple-400'};
  if(advancedPct>0.2)return{level:'B1',desc:'–°—Ä–µ–¥–Ω–∏–π',color:'text-yellow-400'};
  if(advancedPct>0.1)return{level:'A2',desc:'–≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã–π',color:'text-blue-400'};
  return{level:'A1',desc:'–ù–∞—á–∞–ª—å–Ω—ã–π',color:'text-green-400'};
}

// === AUDIO MODE (hands-free) ===
let audioPlaying=false,audioQueue=[],audioIdx=0,audioPaused=false,audioSpeed=1;
const AUDIO_PAUSE=2500; // ms pause between word and translation
const AUDIO_GAP=1500; // ms gap between cards

function startAudioMode(lv,mode){
  const db=getDB();let q=(db[lv]||[]).map((w,i)=>({w:w[0],tr:w[1],ex:w[2],lv,i}));
  if(mode==='due'){const now=Date.now();q=q.filter(x=>{const c=getCard(x.lv,x.i);return c.st>0&&c.due<=now})}
  else if(mode==='new'){q=q.filter(x=>getCard(x.lv,x.i).st===0).slice(0,20)}
  if(!q.length){toast('–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è –∞—É–¥–∏–æ','#6366f1');return}
  audioQueue=q;audioIdx=0;audioPaused=false;audioPlaying=true;S.sc='audio';render();playNextAudio();
}
function startAudioAll(){
  const items=getDailyReview();if(!items.length){toast('–ù–µ—Ç —Å–ª–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è','#6366f1');return}
  const db=getDB();audioQueue=items.slice(0,40).map(x=>({w:db[x.l][x.i][0],tr:db[x.l][x.i][1],ex:db[x.l][x.i][2],lv:x.l,i:x.i}));
  audioIdx=0;audioPaused=false;audioPlaying=true;S.sc='audio';render();playNextAudio();
}
function playNextAudio(){
  if(!audioPlaying||audioPaused||audioIdx>=audioQueue.length){
    if(audioIdx>=audioQueue.length&&audioPlaying){audioPlaying=false;toast('–ê—É–¥–∏–æ —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéß');S.sc='levels';render()}
    return;
  }
  const item=audioQueue[audioIdx];render();
  // Speak English word
  doSpeak(item.w);
  // After pause, speak Russian translation
  setTimeout(()=>{
    if(!audioPlaying||audioPaused)return;
    // Speak Russian
    if('speechSynthesis' in window){
      speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(item.tr);u.lang='ru-RU';u.rate=0.9;
      const v=speechSynthesis.getVoices();const p=v.find(x=>x.lang.startsWith('ru'));if(p)u.voice=p;
      speechSynthesis.speak(u);
    }
    // Next word after gap
    setTimeout(()=>{if(!audioPlaying||audioPaused)return;audioIdx++;playNextAudio()},AUDIO_GAP+item.tr.length*80);
  },AUDIO_PAUSE);
}
function toggleAudioPause(){audioPaused=!audioPaused;if(!audioPaused)playNextAudio();render()}
function stopAudio(){audioPlaying=false;audioPaused=false;speechSynthesis.cancel();S.sc='levels';render()}
function audioSkip(){speechSynthesis.cancel();audioIdx++;playNextAudio()}
function audioBack(){speechSynthesis.cancel();audioIdx=Math.max(0,audioIdx-1);playNextAudio()}

// === WORD TOPICS ===
const TOPICS={
'üë§ –¢–µ–ª–æ':['head','hand','eye','ear','nose','arm','leg','face','heart','foot'],
'üë®‚Äçüë©‚Äçüëß –°–µ–º—å—è':['mother','father','sister','brother','child','boy','girl','man','woman','friend'],
'üè† –î–æ–º':['house','room','door','window','table','chair','bed','floor','wall','kitchen'],
'üçé –ï–¥–∞':['food','bread','milk','egg','meat','rice','cheese','apple','sugar','salt','tea','coffee','juice','cook'],
'üåç –ü—Ä–∏—Ä–æ–¥–∞':['sun','rain','snow','wind','fire','river','sea','tree','flower','bird','star','cloud','garden','mountain'],
'üé® –¶–≤–µ—Ç–∞':['red','green','blue','yellow','white','black'],
'üèÉ –î–µ–π—Å—Ç–≤–∏—è':['run','eat','sleep','walk','sit','stand','talk','listen','read','write','play','swim','fly','drive','cook','wash','dance','sing','wait'],
'üíº –†–∞–±–æ—Ç–∞':['work','money','school','buy','lead','hire','publish','perform','succeed','fail','achieve','effort','skill','talent','result','strategy'],
'üí≠ –ú—ã—à–ª–µ–Ω–∏–µ':['think','know','believe','remember','imagine','realize','understand','assume','recognize','determine','consider','anticipate','perceive','contemplate','speculate'],
'‚ù§Ô∏è –≠–º–æ—Ü–∏–∏':['happy','love','smile','cry','afraid','calm','eager','emotion','courage','doubt','generous','honest','patient'],
'üìä –ë–∏–∑–Ω–µ—Å':['revenue','deadline','efficiency','expansion','priority','strategy','productivity','allocation','incentive','outcome','demand','supply','benefit'],
'‚öñÔ∏è –°–ª–æ–∂–Ω—ã–µ':['ambiguous','unprecedented','sophisticated','feasible','meticulous','prevalent','resilient','volatile','pragmatic','paradigm'],
'üéì –ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–µ':['accomplish','consequence','significant','contribute','establish','evaluate','phenomenon','legislation','accumulate','hypothesis'],
'üëë –†–µ–¥–∫–∏–µ':['acquiesce','ephemeral','quintessential','serendipity','magnanimous','obfuscate','pernicious','conundrum','inexorable','sycophant'],
};

function getTopicWords(topicName){
  const words=TOPICS[topicName]||[];const db=getDB();const result=[];
  words.forEach(w=>{
    for(let l=1;l<=5;l++){const ws=db[l]||[];
      const idx=ws.findIndex(x=>x[0].toLowerCase()===w.toLowerCase());
      if(idx!==-1){result.push({w:ws[idx][0],tr:ws[idx][1],ex:ws[idx][2],h:ws[idx][3],lv:l,i:idx,mode:0});break}
    }
  });
  return result;
}
function goTopic(name){
  const q=getTopicWords(name);if(!q.length)return;
  S.sQ=q;S.cI=0;S.sA=false;S.sH=false;S.sR=[];S.cL=0;S.sM=null;S.sc='study';S.typed='';S.cOpts=[];S.cAns=null;S.sentenceResult=null;
  logEvent('session_start',{topic:name,cards:q.length});render();
}

// === WORD OF THE DAY ===
function getWordOfDay(){
  const db=getDB();const all=[];
  for(let l=2;l<=5;l++){(db[l]||[]).forEach((w,i)=>{const c=getCard(l,i);if(c.st===0)all.push({w:w[0],tr:w[1],ex:w[2],h:w[3],lv:l,i})})}
  if(!all.length)return null;
  // Deterministic based on date
  const d=today();let hash=0;for(let i=0;i<d.length;i++)hash=((hash<<5)-hash)+d.charCodeAt(i);
  hash=Math.abs(hash);
  return all[hash%all.length];
}

// === ACHIEVEMENTS ===
const BADGES=[
  {id:'first10',icon:'üå±',name:'–†–æ—Å—Ç–æ–∫',desc:'–í—ã—É—á–∏ 10 —Å–ª–æ–≤',check:()=>{const db=getDB();let n=0;for(let l=1;l<=5;l++)(db[l]||[]).forEach((_,i)=>{if(getCard(l,i).reps>=3)n++});return n>=10}},
  {id:'first50',icon:'üåø',name:'–ü–æ–±–µ–≥',desc:'–í—ã—É—á–∏ 50 —Å–ª–æ–≤',check:()=>{const db=getDB();let n=0;for(let l=1;l<=5;l++)(db[l]||[]).forEach((_,i)=>{if(getCard(l,i).reps>=3)n++});return n>=50}},
  {id:'first100',icon:'üå≥',name:'–î–µ—Ä–µ–≤–æ',desc:'–í—ã—É—á–∏ 100 —Å–ª–æ–≤',check:()=>{const db=getDB();let n=0;for(let l=1;l<=5;l++)(db[l]||[]).forEach((_,i)=>{if(getCard(l,i).reps>=3)n++});return n>=100}},
  {id:'first300',icon:'üèî',name:'–í–µ—Ä—à–∏–Ω–∞',desc:'–í—ã—É—á–∏ 300 —Å–ª–æ–≤',check:()=>{const db=getDB();let n=0;for(let l=1;l<=5;l++)(db[l]||[]).forEach((_,i)=>{if(getCard(l,i).reps>=3)n++});return n>=300}},
  {id:'streak3',icon:'üî•',name:'–ù–∞ –≤–æ–ª–Ω–µ',desc:'3 –¥–Ω—è –ø–æ–¥—Ä—è–¥',check:()=>(getStreak().current||0)>=3},
  {id:'streak7',icon:'üíé',name:'–ù–µ–¥–µ–ª—è —Å–∏–ª—ã',desc:'7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥',check:()=>(getStreak().current||0)>=7},
  {id:'streak30',icon:'üëë',name:'–ö–æ—Ä–æ–ª—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã',desc:'30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥',check:()=>(getStreak().current||0)>=30},
  {id:'speed',icon:'‚ö°',name:'–°–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª',desc:'–û—Ç–≤–µ—Ç—å –∑–∞ 2 —Å–µ–∫',check:()=>{const log=load(LS_LOG,[]);return log.some(e=>e.type==='answer'&&e.grade>=3&&e.ms&&e.ms<2000)}},
  {id:'perfect',icon:'üíØ',name:'–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç',desc:'–°–µ—Å—Å–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫ (10+ —Å–ª–æ–≤)',check:()=>{const log=load(LS_LOG,[]);const sessions=[];let cur=null;log.filter(e=>e.type==='answer').forEach(e=>{if(!cur||e.t-cur.end>300000){if(cur)sessions.push(cur);cur={end:e.t,n:0,ok:0}}cur.end=e.t;cur.n++;if(e.grade>=3)cur.ok++});if(cur)sessions.push(cur);return sessions.some(s=>s.n>=10&&s.ok===s.n)}},
  {id:'night',icon:'ü¶â',name:'–°–æ–≤–∞',desc:'–£—á–∏—Å—å –ø–æ—Å–ª–µ 23:00',check:()=>{const log=load(LS_LOG,[]);return log.some(e=>e.type==='answer'&&new Date(e.t).getHours()>=23)}},
  {id:'early',icon:'üåÖ',name:'–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫',desc:'–£—á–∏—Å—å –¥–æ 7:00',check:()=>{const log=load(LS_LOG,[]);return log.some(e=>e.type==='answer'&&new Date(e.t).getHours()<7)}},
  {id:'leech',icon:'üó°',name:'–£–±–∏–π—Ü–∞ –ø–∏—è–≤–æ–∫',desc:'–û—Å–≤–æ–π leech-—Å–ª–æ–≤–æ',check:()=>{const p=load(LS.p,{});return Object.values(p).some(c=>c.leech&&c.st===2&&c.reps>=3)}},
  {id:'lvl2',icon:'üîì',name:'–≠–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ!',desc:'–û—Ç–∫—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å 2',check:()=>getUL().includes(2)},
  {id:'lvl3',icon:'üöÄ',name:'–°—Ä–µ–¥–Ω–∏–π –∫–ª–∞—Å—Å',desc:'–û—Ç–∫—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å 3',check:()=>getUL().includes(3)},
  {id:'lvl5',icon:'üèÜ',name:'–ú–∞—Å—Ç–µ—Ä —Å–ª–æ–≤',desc:'–û—Ç–∫—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å 5',check:()=>getUL().includes(5)},
  {id:'tutor',icon:'ü§ñ',name:'–£—á–µ–Ω–∏–∫ AI',desc:'–ò—Å–ø–æ–ª—å–∑—É–π AI —Ç—å—é—Ç–æ—Ä–∞',check:()=>{const log=load(LS_LOG,[]);return log.some(e=>e.type==='tutor')}},
  {id:'reader',icon:'üìñ',name:'–ö–Ω–∏–≥–æ–ª—é–±',desc:'–î–æ–±–∞–≤—å —Å–ª–æ–≤–æ –∏–∑ —á—Ç–µ–Ω–∏—è',check:()=>{const log=load(LS_LOG,[]);return log.some(e=>e.type==='word_added'&&e.source==='reader')}},
  {id:'w50day',icon:'üèãÔ∏è',name:'–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü',desc:'50 —Å–ª–æ–≤ –∑–∞ –¥–µ–Ω—å',check:()=>{const sk=getStreak();return Object.values(sk.days||{}).some(v=>v>=50)}},
  {id:'game',icon:'üéÆ',name:'–ò–≥—Ä–æ–∫',desc:'–°—ã–≥—Ä–∞–π –≤ –º–∏–Ω–∏-–∏–≥—Ä—É',check:()=>{const log=load(LS_LOG,[]);return log.some(e=>e.type==='game')}},
];

function getUnlockedBadges(){return BADGES.filter(b=>b.check())}
function checkNewBadges(){
  const prev=load('vm2_badges',[]);const now=getUnlockedBadges().map(b=>b.id);
  const newOnes=now.filter(id=>!prev.includes(id));
  if(newOnes.length){save('vm2_badges',now);const b=BADGES.find(x=>x.id===newOnes[0]);if(b)toast(b.icon+' '+b.name+'!','#8b5cf6')}
}

// === MINI-GAMES ===
let game={type:null,words:[],pairs:[],matched:[],selected:null,score:0,timer:0,timerRef:null,scramble:'',answer:'',attempts:0,roundWords:[],roundIdx:0,roundStart:0};

function startGame(type){
  const db=getDB();const all=[];
  for(let l=1;l<=5;l++){if(!getUL().includes(l))continue;(db[l]||[]).forEach((w,i)=>{const c=getCard(l,i);if(c.reps>=1)all.push({w:w[0],tr:w[1],lv:l,i})})}
  if(all.length<8){toast('–ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã 8 –∏–∑—É—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤','#ef4444');return}
  game={type,words:all,pairs:[],matched:[],selected:null,score:0,timer:0,timerRef:null,scramble:'',answer:'',attempts:0,roundWords:[],roundIdx:0,roundStart:0};

  if(type==='match'){
    const pick=all.sort(()=>Math.random()-.5).slice(0,6);
    const left=pick.map((w,i)=>({id:'w'+i,text:w.w,pair:i,type:'word'}));
    const right=pick.map((w,i)=>({id:'t'+i,text:w.tr,pair:i,type:'trans'}));
    game.pairs=[...left.sort(()=>Math.random()-.5),...right.sort(()=>Math.random()-.5)];
    game.matched=[];game.timer=60;
  }
  else if(type==='scramble'){
    game.roundWords=all.sort(()=>Math.random()-.5).slice(0,10);game.roundIdx=0;
    nextScramble();
  }
  else if(type==='speed'){
    game.roundWords=all.sort(()=>Math.random()-.5).slice(0,30);game.roundIdx=0;game.timer=60;game.roundStart=Date.now();
  }
  logEvent('game',{type});S.sc='game';render();
  if(type!=='scramble')startGameTimer();
}

function startGameTimer(){if(game.timerRef)clearInterval(game.timerRef);game.timerRef=setInterval(()=>{game.timer--;render();if(game.timer<=0){clearInterval(game.timerRef);endGame()}},1000)}
function endGame(){if(game.timerRef)clearInterval(game.timerRef);game.type+='_end';render()}

// Match game
function selectCard(id){
  if(game.matched.includes(id))return;
  const card=game.pairs.find(p=>p.id===id);if(!card)return;
  if(!game.selected){game.selected=card;render();return}
  if(game.selected.id===id){game.selected=null;render();return}
  if(game.selected.pair===card.pair&&game.selected.type!==card.type){
    game.matched.push(game.selected.id,card.id);game.score+=10;game.selected=null;
    if(game.matched.length===game.pairs.length)endGame();
    else render();
  }else{game.score=Math.max(0,game.score-2);const prev=game.selected;game.selected=null;render()}
}

// Scramble game
function nextScramble(){
  if(game.roundIdx>=game.roundWords.length){endGame();return}
  const w=game.roundWords[game.roundIdx];
  let chars=w.w.split('');for(let i=chars.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[chars[i],chars[j]]=[chars[j],chars[i]]}
  if(chars.join('')===w.w&&chars.length>1){[chars[0],chars[1]]=[chars[1],chars[0]]}
  game.scramble=chars.join('');game.answer='';game.attempts=0;render();
}
function checkScramble(){
  const v=(document.getElementById('scramble-input')||{}).value||'';
  if(v.toLowerCase().trim()===game.roundWords[game.roundIdx].w.toLowerCase()){
    game.score+=10-game.attempts*2;game.roundIdx++;nextScramble();
  }else{game.attempts++;if(game.attempts>=3){game.roundIdx++;nextScramble()}else{toast('–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë!','#ef4444');render()}}
}

// Speed round
function speedAnswer(ok){
  if(ok)game.score++;
  game.roundIdx++;
  if(game.roundIdx>=game.roundWords.length||game.timer<=0)endGame();
  else render();
}

// === ONBOARDING ===
const ONBOARD_WORDS=[
  ['cat','–∫–æ—Ç',1],['house','–¥–æ–º',1],['water','–≤–æ–¥–∞',1],['happy','—Å—á–∞—Å—Ç–ª–∏–≤—ã–π',1],['run','–±–µ–∂–∞—Ç—å',1],
  ['weather','–ø–æ–≥–æ–¥–∞',2],['beautiful','–∫—Ä–∞—Å–∏–≤—ã–π',2],['explain','–æ–±—ä—è—Å–Ω—è—Ç—å',2],['imagine','–ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å',2],['courage','—Å–º–µ–ª–æ—Å—Ç—å',2],
  ['accomplish','–¥–æ—Å—Ç–∏–≥–∞—Ç—å',3],['consequence','–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ',3],['negotiate','–ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',3],['evaluate','–æ—Ü–µ–Ω–∏–≤–∞—Ç—å',3],['phenomenon','—è–≤–ª–µ–Ω–∏–µ',3],
  ['ambiguous','–Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π',4],['scrutinize','–∏–∑—É—á–∞—Ç—å',4],['exacerbate','—É—Å—É–≥—É–±–ª—è—Ç—å',4],['pragmatic','–ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π',4],['resilient','—Å—Ç–æ–π–∫–∏–π',4],
  ['ephemeral','–º–∏–º–æ–ª—ë—Ç–Ω—ã–π',5],['quintessential','—Ç–∏–ø–∏—á–Ω–µ–π—à–∏–π',5],['obfuscate','–∑–∞–ø—É—Ç—ã–≤–∞—Ç—å',5],['sycophant','–ø–æ–¥—Ö–∞–ª–∏–º',5],['inexorable','–Ω–µ—É–º–æ–ª–∏–º—ã–π',5],
];
let onboard={idx:0,results:[],done:false};

function startOnboarding(){onboard={idx:0,results:[],done:false};S.sc='onboard';render()}
function onboardAnswer(knows){
  onboard.results.push({lv:ONBOARD_WORDS[onboard.idx][2],ok:knows});
  onboard.idx++;
  if(onboard.idx>=ONBOARD_WORDS.length){finishOnboarding();return}
  render();
}
function finishOnboarding(){
  // Calculate level from results
  const byLv={};onboard.results.forEach(r=>{if(!byLv[r.lv])byLv[r.lv]={ok:0,n:0};byLv[r.lv].n++;if(r.ok)byLv[r.lv].ok++});
  let suggestedLevel=1;
  for(let l=5;l>=1;l--){if(byLv[l]&&byLv[l].ok/byLv[l].n>=0.6){suggestedLevel=l;break}}
  // Unlock levels up to suggested
  // Mark known words as partially learned
  const db=getDB();
  onboard.results.forEach((r,i)=>{
    if(r.ok){
      const w=ONBOARD_WORDS[i];
      for(let l=1;l<=5;l++){const ws=db[l]||[];const idx=ws.findIndex(x=>x[0].toLowerCase()===w[0].toLowerCase());
        if(idx!==-1){const c=getCard(l,idx);c.st=2;c.step=2;c.reps=3;c.due=Date.now()+86400000;c.ease=2.5;if(!c.firstSeen)c.firstSeen=today();saveCard(l,idx,c);break}}
    }
  });
  onboard.done=true;onboard.suggestedLevel=suggestedLevel;
  onboard.byLv=byLv;save('vm2_onboarded',true);render();
}

// === READING MODE ===
function getWordStatus(word){
  const w=word.toLowerCase();if(STOP.has(w)||w.length<3)return 'stop';
  const db=getDB();
  for(let l=1;l<=5;l++){const ws=db[l]||[];
    const idx=ws.findIndex(x=>x[0].toLowerCase()===w);
    if(idx!==-1){const c=getCard(l,idx);
      if(c.st===2&&c.reps>=3)return 'known';
      if(c.st>0)return 'learning';
      return 'new';
    }
  }
  return 'unknown';
}
function getWordInfo(word){
  const w=word.toLowerCase();const db=getDB();
  for(let l=1;l<=5;l++){const ws=db[l]||[];
    const idx=ws.findIndex(x=>x[0].toLowerCase()===w);
    if(idx!==-1)return{found:true,w:ws[idx][0],tr:ws[idx][1],ex:ws[idx][2],h:ws[idx][3],lv:l,i:idx,card:getCard(l,idx)};
  }
  return{found:false,w:word,tr:null,lv:null};
}

function analyzeText(){
  const txt=document.getElementById('read-input').value.trim();if(!txt){toast('–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç!','#ef4444');return}
  S.readRaw=txt;
  // Tokenize preserving punctuation and whitespace
  const tokens=txt.split(/(\s+|[.,!?;:()"\[\]{}<>\/\\‚Äî‚Äì\-])/);
  let known=0,learning=0,neww=0,unknown=0,stopw=0,total=0;
  let html='';
  tokens.forEach(tok=>{
    const clean=tok.replace(/[^a-zA-Z'-]/g,'');
    if(!clean||!/[a-zA-Z]/.test(tok)){html+=tok.replace(/\n/g,'<br>');return}
    total++;
    const status=getWordStatus(clean);
    let cls='',style='';
    if(status==='known'){cls='cursor-pointer rounded px-0.5 bg-green-500/20 text-green-300 hover:bg-green-500/40';known++}
    else if(status==='learning'){cls='cursor-pointer rounded px-0.5 bg-yellow-500/20 text-yellow-300 hover:bg-yellow-500/40';learning++}
    else if(status==='new'){cls='cursor-pointer rounded px-0.5 bg-blue-500/20 text-blue-300 hover:bg-blue-500/40';neww++}
    else if(status==='unknown'){cls='cursor-pointer rounded px-0.5 bg-red-500/20 text-red-300 hover:bg-red-500/40';unknown++}
    else{cls='text-slate-500';stopw++}
    const safe=clean.replace(/'/g,"\\'");
    if(status!=='stop')html+=`<span class="${cls}" onclick="wordClick('${safe}')">${tok}</span>`;
    else html+=`<span class="${cls}">${tok}</span>`;
  });
  document.getElementById('read-out').innerHTML=html;
  // Stats
  const content=total-stopw;
  const knownPct=content?Math.round((known+learning)/content*100):0;
  document.getElementById('read-stats').innerHTML=`
  <div class="bg-slate-800 rounded-xl p-3">
    <div class="flex justify-between items-center mb-2">
      <div><span class="text-slate-400 text-xs">–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</span></div>
      <div class="flex items-center gap-2"><span class="${estimateCEFR(txt).color} text-xs font-bold">${estimateCEFR(txt).level}</span><span class="text-slate-500 text-xs">${estimateCEFR(txt).desc}</span></div>
    </div>
    <div class="flex justify-between text-xs mb-1"><span class="text-white font-bold">${knownPct}%</span></div>
    <div class="h-2 bg-slate-700 rounded-full overflow-hidden mb-2"><div class="h-full rounded-full" style="width:${knownPct}%;background:linear-gradient(90deg,#22c55e,#eab308)"></div></div>
    <div class="flex gap-3 text-xs flex-wrap">
      <span class="text-green-400">‚úÖ${known}</span>
      <span class="text-yellow-400">üìñ${learning}</span>
      <span class="text-blue-400">üÜï${neww}</span>
      <span class="text-red-400">‚ùì${unknown}</span>
      <span class="text-slate-500">${total} —Å–ª–æ–≤</span>
    </div>
    ${knownPct>=95?'<div class="text-green-400 text-xs mt-2">üéâ –û—Ç–ª–∏—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å! –¢–µ–∫—Å—Ç —Ç–µ–±–µ –ø–æ —Å–∏–ª–∞–º.</div>':
     knownPct>=80?'<div class="text-yellow-400 text-xs mt-2">üëç –•–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–ª–æ–≤ –∑–Ω–∞–∫–æ–º—ã.</div>':
     knownPct>=60?'<div class="text-amber-400 text-xs mt-2">üìö –ï—Å—Ç—å —á—Ç–æ –∏–∑—É—á–∏—Ç—å. –ù–∞–∂–∏–º–∞–π –Ω–∞ –∫—Ä–∞—Å–Ω—ã–µ —Å–ª–æ–≤–∞!</div>':
     '<div class="text-red-400 text-xs mt-2">üí™ –¢–µ–∫—Å—Ç —Å–ª–æ–∂–Ω—ã–π. –î–æ–±–∞–≤—å –Ω–µ–∑–Ω–∞–∫–æ–º—ã–µ —Å–ª–æ–≤–∞!</div>'}
  </div>`;
}

let pendingReadWord=null;
function wordClick(word){
  const info=getWordInfo(word);
  const popup=document.getElementById('read-popup');popup.style.display='block';
  document.getElementById('rp-word').textContent=info.w;
  pendingReadWord=info;

  if(info.found){
    document.getElementById('rp-trans').innerHTML=`<span class="text-cyan-300">${info.tr}</span>`;
    const c=info.card;const stName=c.st===0?'–ù–æ–≤–æ–µ':c.st===2&&c.reps>=3?'–û—Å–≤–æ–µ–Ω–æ':'–£—á—É';
    const stCol=c.st===0?'text-blue-400':c.st===2&&c.reps>=3?'text-green-400':'text-yellow-400';
    document.getElementById('rp-status').innerHTML=`<span class="${stCol}">${stName}</span> | –£—Ä.${info.lv} | ${c.reps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π | ${c.lapses} –æ—à–∏–±–æ–∫${c.leech?' | <span class="text-red-400">ü©∏ –¢—Ä—É–¥–Ω–æ–µ</span>':''}`;
    document.getElementById('rp-add-btn').textContent='‚úÖ –£–∂–µ –≤ —Å–ª–æ–≤–∞—Ä–µ';document.getElementById('rp-add-btn').disabled=true;
    document.getElementById('rp-add-btn').className='py-2 px-4 rounded-xl bg-slate-700 text-slate-400 text-sm';
  }else{
    document.getElementById('rp-trans').innerHTML='<span class="text-slate-400">–ü–µ—Ä–µ–≤–æ–¥–∏–º...</span>';
    document.getElementById('rp-status').innerHTML='<span class="text-red-400">–ù–µ –≤ —Å–ª–æ–≤–∞—Ä–µ</span>';
    document.getElementById('rp-add-btn').textContent='‚ûï –î–æ–±–∞–≤–∏—Ç—å';document.getElementById('rp-add-btn').disabled=false;
    document.getElementById('rp-add-btn').className='py-2 px-4 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold text-sm active:scale-95';
    // Auto-translate
    fetch('https://api.mymemory.translated.net/get?q='+encodeURIComponent(word)+'&langpair=en|ru')
      .then(r=>r.json()).then(d=>{
        const tr=(d.responseData.translatedText||'').trim();
        if(tr&&tr.toLowerCase()!==word.toLowerCase()){
          document.getElementById('rp-trans').innerHTML=`<span class="text-cyan-300">${tr}</span> <span class="text-slate-600 text-xs">(–∞–≤—Ç–æ)</span>`;
          pendingReadWord.autoTr=tr;
        }else document.getElementById('rp-trans').innerHTML='<span class="text-slate-500">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏</span>';
      }).catch(()=>{document.getElementById('rp-trans').innerHTML='<span class="text-slate-500">–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞</span>'});
  }
  doSpeak(word);
}

function addFromReader(){
  if(!pendingReadWord||pendingReadWord.found)return;
  const w=pendingReadWord.w;
  const tr=pendingReadWord.autoTr||'???';
  if(tr==='???'){toast('–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ ‚Äî –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é','#ef4444');return}
  const l=+document.getElementById('rp-level').value;
  const uw=loadUW();uw[l].push([w,tr,w+'.',tr.split(' ')[0]]);save(LS.u,uw);
  toast('+1: '+w);
  document.getElementById('read-popup').style.display='none';
  logEvent('word_added',{w,tr,lv:l,source:'reader'});
  // Re-analyze to update colors
  analyzeText();
}

function showTab(id){['s','b','p'].forEach(t=>{const p=document.getElementById('panel-'+t);const b=document.getElementById('tab-'+t);if(p)p.style.display=t===id?'block':'none';if(b)b.className='flex-1 py-2 rounded-lg text-xs '+(t===id?'bg-indigo-600 text-white font-semibold':'bg-slate-800 text-slate-400')})}

// First launch check
if(!load('vm2_onboarded',false)){S.sc='onboard_intro'}
render();checkNewBadges();

// Keyboard shortcuts (desktop)
document.addEventListener('keydown',e=>{
  if(S.sc!=='study')return;
  const cW=S.sQ[S.cI];if(!cW)return;
  if(e.key===' '&&!S.sA&&cW.mode<=1){e.preventDefault();S.sA=true;render()}
  else if(S.sA&&cW.mode<=1){
    if(e.key==='1')ans(1);else if(e.key==='2')ans(3);else if(e.key==='3')ans(4);
    else if(e.key==='ArrowLeft')ans(1);else if(e.key==='ArrowRight')ans(3);
  }
});

if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
